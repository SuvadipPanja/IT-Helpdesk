// ============================================
// SECURITY CONTROLLER
// Fetches all security-related settings from database
// ============================================
// Developer: Suvadip Panja
// Created: November 08, 2025
// File: backend/controllers/securityController.js
// ============================================
// PURPOSE:
// - Fetch password policy settings
// - Fetch session management settings
// - Fetch account security settings
// - Return all security data in one endpoint
// ============================================

const { executeQuery } = require('../config/database'); // ‚≠ê FIXED: Use executeQuery
const logger = require('../utils/logger');
const { createResponse } = require('../utils/helpers');

/**
 * Get all security settings from database
 * Endpoint: GET /api/v1/security/settings
 */
const getSecuritySettings = async (req, res) => {
  try {
    console.log('üìç Fetching all security settings from database...');

    // Query to fetch ALL security-related settings
    const query = `
      SELECT 
        setting_key,
        setting_value,
        setting_description
      FROM system_settings
      WHERE setting_key IN (
        -- Password Policy
        'password_min_length',
        'password_require_uppercase',
        'password_require_lowercase',
        'password_require_number',
        'password_require_special',
        'password_expiry_days',
        'password_history_count',
        
        -- Session Management
        'session_timeout_minutes',
        'auto_logout_on_inactivity',
        'max_concurrent_sessions',
        
        -- Account Security
        'lockout_attempts',
        'lockout_duration_minutes',
        'two_factor_authentication',
        'ip_whitelist'
      )
      ORDER BY setting_key
    `;

    const result = await executeQuery(query);

    // Convert rows to key-value object
    const settings = {};
    result.recordset.forEach(row => {
      settings[row.setting_key] = row.setting_value;
    });

    console.log('‚úÖ Security settings fetched:', settings);

    // ‚≠ê IMPORTANT: Check if password_history_count exists
    if (!settings.password_history_count) {
      console.warn('‚ö†Ô∏è WARNING: password_history_count is missing from database!');
    }

    // Return response
    return res.status(200).json({
      success: true,
      message: 'Security settings fetched successfully',
      data: settings,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('‚ùå Error fetching security settings:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to fetch security settings',
      error: error.message
    });
  }
};

/**
 * Get password policy settings only
 * Endpoint: GET /api/v1/security/password-policy
 */
const getPasswordPolicy = async (req, res) => {
  try {
    console.log('üìç Fetching password policy settings...');

    const query = `
      SELECT 
        setting_key,
        setting_value
      FROM system_settings
      WHERE setting_key IN (
        'password_min_length',
        'password_require_uppercase',
        'password_require_lowercase',
        'password_require_number',
        'password_require_special',
        'password_expiry_days',
        'password_history_count'
      )
    `;

    const result = await executeQuery(query);

    const policy = {};
    result.recordset.forEach(row => {
      policy[row.setting_key] = row.setting_value;
    });

    console.log('‚úÖ Password policy fetched:', policy);

    return res.status(200).json({
      success: true,
      message: 'Password policy fetched successfully',
      data: policy,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('‚ùå Error fetching password policy:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to fetch password policy',
      error: error.message
    });
  }
};

/**
 * Get session management settings only
 * Endpoint: GET /api/v1/security/session-settings
 */
const getSessionSettings = async (req, res) => {
  try {
    console.log('üìç Fetching session settings...');

    const query = `
      SELECT 
        setting_key,
        setting_value
      FROM system_settings
      WHERE setting_key IN (
        'session_timeout_minutes',
        'auto_logout_on_inactivity',
        'max_concurrent_sessions'
      )
    `;

    const result = await executeQuery(query);

    const settings = {};
    result.recordset.forEach(row => {
      settings[row.setting_key] = row.setting_value;
    });

    console.log('‚úÖ Session settings fetched:', settings);

    return res.status(200).json({
      success: true,
      message: 'Session settings fetched successfully',
      data: settings,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('‚ùå Error fetching session settings:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to fetch session settings',
      error: error.message
    });
  }
};

/**
 * Get account security settings only
 * Endpoint: GET /api/v1/security/account-settings
 */
const getAccountSecuritySettings = async (req, res) => {
  try {
    console.log('üìç Fetching account security settings...');

    const query = `
      SELECT 
        setting_key,
        setting_value
      FROM system_settings
      WHERE setting_key IN (
        'lockout_attempts',
        'lockout_duration_minutes',
        'two_factor_authentication',
        'ip_whitelist'
      )
    `;

    const result = await executeQuery(query);

    const settings = {};
    result.recordset.forEach(row => {
      settings[row.setting_key] = row.setting_value;
    });

    console.log('‚úÖ Account security settings fetched:', settings);

    return res.status(200).json({
      success: true,
      message: 'Account security settings fetched successfully',
      data: settings,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('‚ùå Error fetching account security settings:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to fetch account security settings',
      error: error.message
    });
  }
};

module.exports = {
  getSecuritySettings,
  getPasswordPolicy,
  getSessionSettings,
  getAccountSecuritySettings
};

