// ============================================
// FILE: passwordExpiry.job.js
// LOCATION: backend/jobs/passwordExpiry.job.js
// FULL PATH: D:\Project\it-helpdesk\backend\jobs\passwordExpiry.job.js
// PURPOSE: Background job to send password expiry reminders
// DEVELOPER: Suvadip Panja
// DATE: November 08, 2025
// ============================================

const cron = require('node-cron');
const passwordExpiryService = require('../services/passwordExpiry.service');
const emailService = require('../services/email.service');
const logger = require('../utils/logger');

let cronJob = null;
let isRunning = false;

const processPasswordExpiryReminders = async () => {
  if (isRunning) {
    logger.warn('Password expiry reminder job already running, skipping this execution');
    return;
  }

  try {
    isRunning = true;
    logger.separator('PASSWORD EXPIRY REMINDER JOB');
    logger.info('Starting password expiry reminder job');

    const users = await passwordExpiryService.getUsersWithExpiringPasswords({
      includeExpired: true,
      includeWarning: true,
      limit: 1000
    });

    if (users.length === 0) {
      logger.info('No users with expiring passwords');
      logger.separator();
      isRunning = false;
      return;
    }

    logger.info(`Found ${users.length} users with expiring/expired passwords`);

    let emailsSent = 0;
    let emailsFailed = 0;

    for (const user of users) {
      try {
        const daysRemaining = user.daysRemaining;
        const expired = user.expired;
        
        if (expired) {
          logger.try(`Sending EXPIRED notification to ${user.username}`, {
            email: user.email,
            expired: true
          });

          await emailService.queueEmail({
            to: user.email,
            subject: 'Password Expired - Action Required',
            templateName: 'password_expired',
            templateData: {
              user_name: user.fullName || user.username,
              expired_date: new Date(user.passwordExpiresAt).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              }),
              support_email: process.env.SUPPORT_EMAIL || 'support@company.com',
              change_password_url: `${process.env.FRONTEND_URL || 'http://localhost:5173'}/profile/change-password`
            },
            priority: 'high',
            category: 'security'
          });

          emailsSent++;
          logger.success(`EXPIRED notification sent to ${user.username}`);
        } 
        else if ([30, 14, 7, 3, 1].includes(daysRemaining)) {
          logger.try(`Sending expiry reminder to ${user.username}`, {
            email: user.email,
            daysRemaining
          });

          await emailService.queueEmail({
            to: user.email,
            subject: `Password Expiring Soon - ${daysRemaining} day${daysRemaining > 1 ? 's' : ''} remaining`,
            templateName: 'password_expiry_warning',
            templateData: {
              user_name: user.fullName || user.username,
              days_remaining: daysRemaining,
              expiry_date: new Date(user.passwordExpiresAt).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              }),
              change_password_url: `${process.env.FRONTEND_URL || 'http://localhost:5173'}/profile/change-password`
            },
            priority: daysRemaining <= 3 ? 'high' : 'normal',
            category: 'security'
          });

          emailsSent++;
          logger.success(`Reminder sent to ${user.username} (${daysRemaining} days)`);
        }
      } catch (error) {
        emailsFailed++;
        logger.error(`Failed to send reminder to ${user.username}`, error);
      }
    }

    logger.separator();
    logger.success('Password expiry reminder job completed', {
      totalUsers: users.length,
      emailsSent,
      emailsFailed
    });
    logger.separator();

  } catch (error) {
    logger.error('Password expiry reminder job error', error);
    logger.separator();
  } finally {
    isRunning = false;
  }
};

const start = () => {
  if (cronJob) {
    logger.warn('Password expiry reminder job already started');
    return;
  }

  cronJob = cron.schedule('0 9 * * *', async () => {
    logger.info('â° Password expiry reminder job triggered (Daily at 9:00 AM IST)');
    await processPasswordExpiryReminders();
  }, {
    scheduled: true,
    timezone: 'Asia/Kolkata'
  });

  logger.success('Password expiry reminder job scheduled (Daily at 9:00 AM IST)');
};

const stop = () => {
  if (cronJob) {
    cronJob.stop();
    cronJob = null;
    logger.info('Password expiry reminder job stopped');
  }
};

const runNow = async () => {
  logger.info('Running password expiry reminder job manually');
  await processPasswordExpiryReminders();
};

module.exports = {
  start,
  stop,
  runNow
};