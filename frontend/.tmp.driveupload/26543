/**
 * ============================================
 * TICKETS LIST PAGE - WITH ANIMATED BUCKETS
 * ============================================
 * 
 * Features:
 * - 2 Animated buckets: "Created by Me" & "Assigned to Me"
 * - Buckets ONLY visible to IT Staff (Admin/Manager/Engineer)
 * - Profile pictures properly displayed
 * - Fixed bucket stats
 * 
 * Developer: Suvadip Panja
 * Company: Digitide
 * Updated: February 2026
 * ============================================
 */

import { useState, useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import {
  Ticket,
  Plus,
  Search,
  Filter,
  RefreshCw,
  Download,
  ChevronLeft,
  ChevronRight,
  AlertCircle,
  Clock,
  CheckCircle,
  XCircle,
  Eye,
  Edit,
  Trash2,
  MoreVertical,
  User,
  UserCheck,
  Calendar,
  Tag,
  AlertTriangle,
  X,
  TrendingUp,
  Sparkles
} from 'lucide-react';
import api from '../../services/api';
import '../../styles/TicketsList.css';

const TicketsList = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  // Read filters from URL
  const statusFromUrl = searchParams.get('status');
  const slaStatusFromUrl = searchParams.get('sla_status');
  const isEscalatedFromUrl = searchParams.get('is_escalated');

  // ============================================
  // BUCKET STATE - Only for IT Staff
  // ============================================
  const [activeBucket, setActiveBucket] = useState(null);
  const [bucketStats, setBucketStats] = useState({ created: 0, assigned: 0 });
  const [bucketLoading, setBucketLoading] = useState(false);

  // Check if user is IT Staff (can see buckets)
  const isITStaff = ['Admin', 'Manager', 'IT Engineer', 'Engineer'].includes(user?.role_name) ||
    user?.permissions?.can_assign_tickets ||
    user?.permissions?.can_view_all_tickets;

  // Check if user is a normal user
  const isNormalUser = user?.role_name === 'User' && !user?.permissions?.can_view_all_tickets;

  // ============================================
  // EXISTING STATE
  // ============================================
  const [tickets, setTickets] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Pagination
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalRecords, setTotalRecords] = useState(0);
  const [limit, setLimit] = useState(10);

  // Filters
  const [filters, setFilters] = useState({
    search: '',
    status_id: '',
    priority_id: '',
    category_id: '',
    assigned_to: '',
    requester_id: '',
    sla_status: '',
    is_escalated: ''
  });

  // Lookup data
  const [statuses, setStatuses] = useState([]);
  const [priorities, setPriorities] = useState([]);
  const [categories, setCategories] = useState([]);
  const [engineers, setEngineers] = useState([]);

  // Sorting
  const [sortBy, setSortBy] = useState('created_at');
  const [sortOrder, setSortOrder] = useState('DESC');

  // UI
  const [showFilters, setShowFilters] = useState(false);
  const [activeDropdown, setActiveDropdown] = useState(null);

  // ============================================
  // GET PROFILE PICTURE URL - SAME AS ORIGINAL
  // ============================================
  const getProfilePictureUrl = (profilePicture) => {
    if (!profilePicture) {
      return null;
    }
    
    // If it's already a full URL
    if (profilePicture.startsWith('http://') || profilePicture.startsWith('https://')) {
      return profilePicture;
    }
    
    // Get base URL WITHOUT /api/v1 for static files
    const baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:5000/api/v1';
    const urlWithoutApi = baseUrl.replace('/api/v1', '');
    
    // Ensure profilePicture starts with /
    const cleanPath = profilePicture.startsWith('/') ? profilePicture : `/${profilePicture}`;
    
    return `${urlWithoutApi}${cleanPath}`;
  };

  // ============================================
  // EFFECTS
  // ============================================
  useEffect(() => {
    fetchDropdownData();
  }, []);

  useEffect(() => {
    fetchTickets();
  }, [currentPage, limit, sortBy, sortOrder, filters, activeBucket]);

  // Fetch bucket stats for IT Staff
  useEffect(() => {
    if (isITStaff && user?.user_id) {
      fetchBucketStats();
    }
  }, [user, isITStaff]);

  // Apply URL filters
  useEffect(() => {
    if (statusFromUrl && statuses.length > 0) {
      const matchingStatus = statuses.find(s => s.status_code === statusFromUrl);
      if (matchingStatus) {
        setFilters(prev => ({ ...prev, status_id: matchingStatus.status_id.toString() }));
        setShowFilters(true);
      }
    }
  }, [statusFromUrl, statuses]);

  useEffect(() => {
    if (slaStatusFromUrl) {
      setFilters(prev => ({ ...prev, sla_status: slaStatusFromUrl }));
      setShowFilters(true);
    }
  }, [slaStatusFromUrl]);

  useEffect(() => {
    if (isEscalatedFromUrl) {
      setFilters(prev => ({ ...prev, is_escalated: isEscalatedFromUrl }));
      setShowFilters(true);
    }
  }, [isEscalatedFromUrl]);

  // ============================================
  // FETCH DROPDOWN DATA
  // ============================================
  const fetchDropdownData = async () => {
    try {
      const [statusesRes, prioritiesRes, categoriesRes, engineersRes] = await Promise.all([
        api.get('/system/statuses'),
        api.get('/system/priorities'),
        api.get('/system/categories'),
        api.get('/system/engineers')
      ]);

      if (statusesRes.data.success) setStatuses(statusesRes.data.data);
      if (prioritiesRes.data.success) setPriorities(prioritiesRes.data.data);
      if (categoriesRes.data.success) setCategories(categoriesRes.data.data);
      if (engineersRes.data.success) setEngineers(engineersRes.data.data);
    } catch (err) {
      console.error('Error fetching dropdown data:', err);
    }
  };

  // ============================================
  // FETCH BUCKET STATS - FIXED
  // ============================================
  const fetchBucketStats = async () => {
    if (!user?.user_id) return;
    
    setBucketLoading(true);
    try {
      console.log('ðŸ“Š Fetching bucket stats for user:', user.user_id);
      
      // Fetch created by me count
      const createdRes = await api.get('/tickets', { 
        params: { 
          page: 1, 
          limit: 1, 
          requester_id: user.user_id 
        } 
      });
      
      // Fetch assigned to me count
      const assignedRes = await api.get('/tickets', { 
        params: { 
          page: 1, 
          limit: 1, 
          assigned_to: user.user_id 
        } 
      });

      // Extract totals from response
      const createdTotal = createdRes.data.data?.pagination?.total || 
                          createdRes.data.pagination?.total || 
                          createdRes.data.data?.length || 0;
                          
      const assignedTotal = assignedRes.data.data?.pagination?.total || 
                           assignedRes.data.pagination?.total || 
                           assignedRes.data.data?.length || 0;

      console.log('ðŸ“Š Bucket stats:', { created: createdTotal, assigned: assignedTotal });

      setBucketStats({
        created: createdTotal,
        assigned: assignedTotal
      });
    } catch (err) {
      console.error('Error fetching bucket stats:', err);
    } finally {
      setBucketLoading(false);
    }
  };

  // ============================================
  // FETCH TICKETS
  // ============================================
  const fetchTickets = async () => {
    try {
      setLoading(true);
      setError('');

      const params = {
        page: currentPage,
        limit: limit,
        sortBy: sortBy,
        sortOrder: sortOrder,
        ...Object.fromEntries(
          Object.entries(filters).filter(([_, value]) => value !== '')
        )
      };

      // Apply bucket filtering
      if (activeBucket === 'created') {
        params.requester_id = user?.user_id;
      } else if (activeBucket === 'assigned') {
        params.assigned_to = user?.user_id;
      } else {
        // Default view - role-based filtering
        if (isNormalUser) {
          params.requester_id = user?.user_id;
        } else if (user?.role_name === 'Engineer' && !user?.permissions?.can_view_all_tickets) {
          params.assigned_to_or_created_by = user?.user_id;
        }
      }

      console.log('ðŸ“¤ Fetching tickets with params:', params);

      const response = await api.get('/tickets', { params });

      console.log('ðŸ“¥ Full API Response:', response.data);

      if (response.data.success) {
        const responseData = response.data.data;
        const ticketsData = responseData?.tickets || responseData || [];
        const paginationData = responseData?.pagination || {};
        
        const ticketsArray = Array.isArray(ticketsData) ? ticketsData : [];
        
        setTickets(ticketsArray);
        setTotalRecords(paginationData.total || ticketsArray.length);
        setTotalPages(paginationData.totalPages || Math.ceil((paginationData.total || ticketsArray.length) / limit));
      }
    } catch (err) {
      console.error('âŒ Error fetching tickets:', err);
      setError(err.response?.data?.message || 'Failed to load tickets');
    } finally {
      setLoading(false);
    }
  };

  // ============================================
  // BUCKET HANDLER
  // ============================================
  const handleBucketChange = (bucket) => {
    // Toggle - clicking same bucket deselects it
    setActiveBucket(activeBucket === bucket ? null : bucket);
    setCurrentPage(1);
  };

  // ============================================
  // EXPORT TICKETS
  // ============================================
  const exportTickets = async () => {
    try {
      const params = {
        sortBy,
        sortOrder,
        ...Object.fromEntries(
          Object.entries(filters).filter(([_, value]) => value !== '')
        )
      };

      if (activeBucket === 'created') params.requester_id = user?.user_id;
      if (activeBucket === 'assigned') params.assigned_to = user?.user_id;

      const response = await api.get('/tickets/export', { params, responseType: 'blob' });

      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `tickets_${activeBucket || 'all'}_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      link.remove();
    } catch (err) {
      console.error('Export error:', err);
      alert('Failed to export tickets');
    }
  };

  // ============================================
  // FILTER HANDLERS
  // ============================================
  const handleFilterChange = (field, value) => {
    setFilters(prev => ({ ...prev, [field]: value }));
    setCurrentPage(1);
  };

  const clearFilters = () => {
    setFilters({
      search: '', status_id: '', priority_id: '', category_id: '',
      assigned_to: '', requester_id: '', sla_status: '', is_escalated: ''
    });
    setCurrentPage(1);
  };

  const handleSort = (field) => {
    if (sortBy === field) {
      setSortOrder(sortOrder === 'ASC' ? 'DESC' : 'ASC');
    } else {
      setSortBy(field);
      setSortOrder('DESC');
    }
  };

  // ============================================
  // NAVIGATION
  // ============================================
  const viewTicket = (id) => navigate(`/tickets/${id}`);
  const editTicket = (id) => navigate(`/tickets/edit/${id}`);

  const deleteTicket = async (ticketId) => {
    if (!window.confirm('Delete this ticket?')) return;
    try {
      await api.delete(`/tickets/${ticketId}`);
      fetchTickets();
      fetchBucketStats();
    } catch (err) {
      alert(err.response?.data?.message || 'Failed to delete');
    }
  };

  const toggleDropdown = (ticketId) => {
    setActiveDropdown(activeDropdown === ticketId ? null : ticketId);
  };

  // ============================================
  // HELPERS
  // ============================================
  const getStatusBadgeClass = (code) => ({
    'OPEN': 'status-open', 'IN_PROGRESS': 'status-progress', 'PENDING': 'status-pending',
    'ON_HOLD': 'status-on-hold', 'RESOLVED': 'status-resolved', 'CLOSED': 'status-closed',
    'ESCALATED': 'status-escalated', 'CANCELLED': 'status-cancelled'
  }[code] || 'status-default');

  const getPriorityBadgeClass = (code) => ({
    'CRITICAL': 'priority-critical', 'HIGH': 'priority-high', 'MEDIUM': 'priority-medium',
    'LOW': 'priority-low', 'PLANNING': 'priority-planning'
  }[code] || 'priority-default');

  const formatDate = (dateString) => {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('en-IN', {
      day: 'numeric', month: 'short', year: 'numeric'
    });
  };

  const formatRelativeTime = (dateString) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      if (diffHours === 0) {
        const diffMins = Math.floor(diffMs / (1000 * 60));
        return diffMins <= 1 ? 'Just now' : `${diffMins}m ago`;
      }
      return `${diffHours}h ago`;
    }
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays}d ago`;
    return formatDate(dateString);
  };

  const canEditTicket = (ticket) => {
    if (user?.permissions?.can_assign_tickets) return true;
    if (ticket.requester_id === user?.user_id) return true;
    if (ticket.assigned_to === user?.user_id) return true;
    return false;
  };

  const getActiveFilterCount = () => Object.values(filters).filter(v => v !== '').length;

  const getPageTitle = () => {
    if (activeBucket === 'created') return 'My Created Tickets';
    if (activeBucket === 'assigned') return 'Assigned to Me';
    return 'Support Tickets';
  };

  // ============================================
  // RENDER
  // ============================================
  return (
    <div className="tickets-page">
      {/* Page Header */}
      <div className="page-header">
        <div className="header-left">
          <div className="page-title-wrapper">
            <div className="page-icon-wrapper">
              <Ticket size={28} className="page-icon" />
            </div>
            <div>
              <h1 className="page-title">{getPageTitle()}</h1>
              <p className="page-subtitle">
                {totalRecords > 0 ? `${totalRecords} ticket${totalRecords !== 1 ? 's' : ''} found` : 'No tickets available'}
              </p>
            </div>
          </div>
        </div>
        <div className="header-right">
          <button 
            className="btn-icon-action" 
            onClick={() => { fetchTickets(); if(isITStaff) fetchBucketStats(); }} 
            title="Refresh"
            disabled={loading}
          >
            <RefreshCw size={18} className={loading ? 'spinning' : ''} />
          </button>
          <button 
            className="btn-icon-action" 
            onClick={exportTickets}
            title="Export to CSV"
            disabled={loading || tickets.length === 0}
          >
            <Download size={18} />
          </button>
          {user?.permissions?.can_create_tickets && (
            <button 
              className="btn-primary-action"
              onClick={() => navigate('/tickets/create')}
            >
              <Plus size={20} />
              <span>Create Ticket</span>
            </button>
          )}
        </div>
      </div>

      {/* ============================================
          ANIMATED BUCKETS - Only for IT Staff
          ============================================ */}
      {isITStaff && (
        <div className="tl-buckets-container">
          {/* Created by Me Bucket */}
          <div 
            className={`tl-bucket tl-bucket-created ${activeBucket === 'created' ? 'tl-bucket-active' : ''}`}
            onClick={() => handleBucketChange('created')}
          >
            <div className="tl-bucket-bg"></div>
            <div className="tl-bucket-wave"></div>
            <div className="tl-bucket-content">
              <div className="tl-bucket-icon">
                <User size={28} />
              </div>
              <div className="tl-bucket-info">
                <span className="tl-bucket-label">Created by Me</span>
                <span className="tl-bucket-count">
                  {bucketLoading ? '...' : bucketStats.created}
                </span>
              </div>
              {activeBucket === 'created' && (
                <div className="tl-bucket-check">
                  <CheckCircle size={20} />
                </div>
              )}
            </div>
            <div className="tl-bucket-sparkle">
              <Sparkles size={18} />
            </div>
          </div>

          {/* Assigned to Me Bucket */}
          <div 
            className={`tl-bucket tl-bucket-assigned ${activeBucket === 'assigned' ? 'tl-bucket-active' : ''}`}
            onClick={() => handleBucketChange('assigned')}
          >
            <div className="tl-bucket-bg"></div>
            <div className="tl-bucket-wave"></div>
            <div className="tl-bucket-content">
              <div className="tl-bucket-icon">
                <UserCheck size={28} />
              </div>
              <div className="tl-bucket-info">
                <span className="tl-bucket-label">Assigned to Me</span>
                <span className="tl-bucket-count">
                  {bucketLoading ? '...' : bucketStats.assigned}
                </span>
              </div>
              {activeBucket === 'assigned' && (
                <div className="tl-bucket-check">
                  <CheckCircle size={20} />
                </div>
              )}
            </div>
            <div className="tl-bucket-sparkle">
              <Sparkles size={18} />
            </div>
          </div>
        </div>
      )}

      {/* Search and Filter Bar */}
      <div className="filter-section">
        <div className="search-wrapper">
          <Search size={18} className="search-icon" />
          <input
            type="text"
            placeholder="Search by ticket #, title, or requester..."
            className="search-input-large"
            value={filters.search}
            onChange={(e) => handleFilterChange('search', e.target.value)}
          />
          {filters.search && (
            <button className="search-clear-btn" onClick={() => handleFilterChange('search', '')}>
              <X size={16} />
            </button>
          )}
        </div>

        <div className="filter-actions">
          <button 
            className={`btn-filter ${showFilters ? 'active' : ''}`}
            onClick={() => setShowFilters(!showFilters)}
          >
            <Filter size={18} />
            <span>Filters</span>
            {getActiveFilterCount() > 0 && (
              <span className="filter-count">{getActiveFilterCount()}</span>
            )}
          </button>

          {getActiveFilterCount() > 0 && (
            <button className="btn-clear-filters" onClick={clearFilters}>
              <X size={16} />
              Clear All
            </button>
          )}
        </div>
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <div className="filters-panel">
          <div className="filters-grid">
            <div className="filter-item">
              <label className="filter-label"><Tag size={14} />Status</label>
              <select value={filters.status_id} onChange={(e) => handleFilterChange('status_id', e.target.value)} className="filter-select">
                <option value="">All Statuses</option>
                {statuses.map((s) => <option key={s.status_id} value={s.status_id}>{s.status_name}</option>)}
              </select>
            </div>

            <div className="filter-item">
              <label className="filter-label"><AlertTriangle size={14} />Priority</label>
              <select value={filters.priority_id} onChange={(e) => handleFilterChange('priority_id', e.target.value)} className="filter-select">
                <option value="">All Priorities</option>
                {priorities.map((p) => <option key={p.priority_id} value={p.priority_id}>{p.priority_name}</option>)}
              </select>
            </div>

            <div className="filter-item">
              <label className="filter-label"><Ticket size={14} />Category</label>
              <select value={filters.category_id} onChange={(e) => handleFilterChange('category_id', e.target.value)} className="filter-select">
                <option value="">All Categories</option>
                {categories.map((c) => <option key={c.category_id} value={c.category_id}>{c.category_name}</option>)}
              </select>
            </div>

            {isITStaff && !activeBucket && (
              <div className="filter-item">
                <label className="filter-label"><User size={14} />Assigned To</label>
                <select value={filters.assigned_to} onChange={(e) => handleFilterChange('assigned_to', e.target.value)} className="filter-select">
                  <option value="">All Engineers</option>
                  <option value="unassigned">Unassigned</option>
                  {engineers.map((e) => <option key={e.user_id} value={e.user_id}>{e.full_name}</option>)}
                </select>
              </div>
            )}

            <div className="filter-item">
              <label className="filter-label"><Clock size={14} />SLA Status</label>
              <select value={filters.sla_status} onChange={(e) => handleFilterChange('sla_status', e.target.value)} className="filter-select">
                <option value="">All SLA Status</option>
                <option value="ok">ðŸŸ¢ On Track</option>
                <option value="warning">ðŸŸ¡ At Risk</option>
                <option value="breached">ðŸ”´ Breached</option>
              </select>
            </div>

            <div className="filter-item">
              <label className="filter-label"><AlertCircle size={14} />Escalated</label>
              <select value={filters.is_escalated} onChange={(e) => handleFilterChange('is_escalated', e.target.value)} className="filter-select">
                <option value="">All Tickets</option>
                <option value="true">Escalated Only</option>
                <option value="false">Not Escalated</option>
              </select>
            </div>
          </div>
        </div>
      )}

      {/* Error */}
      {error && (
        <div className="alert alert-error">
          <AlertCircle size={20} />
          <span>{error}</span>
          <button onClick={() => setError('')} className="alert-close"><X size={16} /></button>
        </div>
      )}

      {/* Tickets Table */}
      <div className="table-container">
        {loading ? (
          <div className="loading-state">
            <div className="spinner"></div>
            <p>Loading tickets...</p>
          </div>
        ) : tickets.length === 0 ? (
          <div className="empty-state">
            <div className="empty-icon-wrapper">
              <Ticket size={64} className="empty-icon" />
            </div>
            <h3>No tickets found</h3>
            <p className="empty-description">
              {getActiveFilterCount() > 0
                ? 'No tickets match your current filters.'
                : activeBucket === 'created'
                ? "You haven't created any tickets yet."
                : activeBucket === 'assigned'
                ? "No tickets assigned to you."
                : "No tickets available."}
            </p>
            {user?.permissions?.can_create_tickets && activeBucket !== 'assigned' && (
              <button className="btn-primary-action" onClick={() => navigate('/tickets/create')}>
                <Plus size={20} />
                <span>Create Ticket</span>
              </button>
            )}
          </div>
        ) : (
          <>
            <div className="table-wrapper">
              <table className="tickets-table">
                <thead>
                  <tr>
                    <th onClick={() => handleSort('ticket_number')} className="sortable th-ticket-number">
                      <div className="th-content">
                        <span>Ticket #</span>
                        {sortBy === 'ticket_number' && <span className="sort-indicator">{sortOrder === 'ASC' ? 'â†‘' : 'â†“'}</span>}
                      </div>
                    </th>
                    <th onClick={() => handleSort('subject')} className="sortable th-title">
                      <div className="th-content">
                        <span>Title & Details</span>
                        {sortBy === 'subject' && <span className="sort-indicator">{sortOrder === 'ASC' ? 'â†‘' : 'â†“'}</span>}
                      </div>
                    </th>
                    <th className="th-category">Category</th>
                    <th onClick={() => handleSort('priority_level')} className="sortable th-priority">
                      <div className="th-content">
                        <span>Priority</span>
                        {sortBy === 'priority_level' && <span className="sort-indicator">{sortOrder === 'ASC' ? 'â†‘' : 'â†“'}</span>}
                      </div>
                    </th>
                    <th onClick={() => handleSort('status_id')} className="sortable th-status">
                      <div className="th-content">
                        <span>Status</span>
                        {sortBy === 'status_id' && <span className="sort-indicator">{sortOrder === 'ASC' ? 'â†‘' : 'â†“'}</span>}
                      </div>
                    </th>
                    <th className="th-requester">Requester</th>
                    <th className="th-assigned">Assigned To</th>
                    <th onClick={() => handleSort('created_at')} className="sortable th-created">
                      <div className="th-content">
                        <span>Created</span>
                        {sortBy === 'created_at' && <span className="sort-indicator">{sortOrder === 'ASC' ? 'â†‘' : 'â†“'}</span>}
                      </div>
                    </th>
                    <th className="th-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {tickets.map((ticket) => (
                    <tr 
                      key={ticket.ticket_id}
                      className={ticket.is_escalated ? 'escalated' : ''}
                      onClick={() => viewTicket(ticket.ticket_id)}
                    >
                      <td>
                        <div className="ticket-number-wrapper">
                          {ticket.is_escalated && <AlertTriangle size={14} className="escalated-icon" />}
                          <span className="ticket-number">#{ticket.ticket_number}</span>
                        </div>
                      </td>
                      <td>
                        <div className="ticket-title-wrapper">
                          <span className="ticket-title">{ticket.subject || ticket.title || 'No Title'}</span>
                          {ticket.description && (
                            <span className="ticket-desc">{ticket.description.substring(0, 60)}...</span>
                          )}
                        </div>
                      </td>
                      <td><span className="category-badge">{ticket.category_name || '-'}</span></td>
                      <td><span className={`priority-badge ${getPriorityBadgeClass(ticket.priority_code)}`}>{ticket.priority_name}</span></td>
                      <td><span className={`status-badge ${getStatusBadgeClass(ticket.status_code)}`}>{ticket.status_name}</span></td>
                      
                      {/* Requester Cell - WITH PROFILE PICTURE */}
                      <td className="requester-cell">
                        <div className="user-info" title={ticket.requester_name}>
                          <div className="user-avatar">
                            {ticket.requester_profile_picture ? (
                              <img 
                                src={getProfilePictureUrl(ticket.requester_profile_picture)} 
                                alt={ticket.requester_name}
                                className="avatar-image"
                                onError={(e) => {
                                  e.target.style.display = 'none';
                                  e.target.nextElementSibling.style.display = 'flex';
                                }}
                              />
                            ) : null}
                            <User 
                              size={14} 
                              style={{ display: ticket.requester_profile_picture ? 'none' : 'flex' }}
                            />
                          </div>
                          <span className="user-name">{ticket.requester_name || 'Unknown'}</span>
                        </div>
                      </td>
                      
                      {/* Assigned To Cell - WITH PROFILE PICTURE */}
                      <td className="assigned-cell">
                        {ticket.assigned_to_name ? (
                          <div className="user-info" title={ticket.assigned_to_name}>
                            <div className="user-avatar assigned">
                              {ticket.assigned_profile_picture ? (
                                <img 
                                  src={getProfilePictureUrl(ticket.assigned_profile_picture)} 
                                  alt={ticket.assigned_to_name}
                                  className="avatar-image"
                                  onError={(e) => {
                                    e.target.style.display = 'none';
                                    e.target.nextElementSibling.style.display = 'flex';
                                  }}
                                />
                              ) : null}
                              <User 
                                size={14}
                                style={{ display: ticket.assigned_profile_picture ? 'none' : 'flex' }}
                              />
                            </div>
                            <span className="user-name">{ticket.assigned_to_name}</span>
                          </div>
                        ) : (
                          <span className="text-muted">Unassigned</span>
                        )}
                      </td>
                      
                      <td className="date-cell">
                        <div className="date-info">
                          <span className="date-relative">{formatRelativeTime(ticket.created_at)}</span>
                          <span className="date-full">{formatDate(ticket.created_at)}</span>
                        </div>
                      </td>
                      
                      <td className="actions-cell" onClick={(e) => e.stopPropagation()}>
                        <div className="action-buttons">
                          <div className="dropdown-wrapper">
                            <button
                              className="btn-action-table more"
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleDropdown(ticket.ticket_id);
                              }}
                            >
                              <MoreVertical size={16} />
                            </button>
                            {activeDropdown === ticket.ticket_id && (
                              <div className="dropdown-menu">
                                <button className="dropdown-item" onClick={() => { viewTicket(ticket.ticket_id); setActiveDropdown(null); }}>
                                  <Eye size={14} /><span>View Details</span>
                                </button>
                                {canEditTicket(ticket) && (
                                  <button className="dropdown-item" onClick={() => { editTicket(ticket.ticket_id); setActiveDropdown(null); }}>
                                    <Edit size={14} /><span>Edit Ticket</span>
                                  </button>
                                )}
                                {user?.permissions?.can_delete_tickets && (
                                  <>
                                    <div className="dropdown-divider"></div>
                                    <button className="dropdown-item danger" onClick={() => { deleteTicket(ticket.ticket_id); setActiveDropdown(null); }}>
                                      <Trash2 size={14} /><span>Delete</span>
                                    </button>
                                  </>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            <div className="pagination-container">
              <div className="pagination-info">
                Showing <strong>{((currentPage - 1) * limit) + 1}</strong> to{' '}
                <strong>{Math.min(currentPage * limit, totalRecords)}</strong> of{' '}
                <strong>{totalRecords}</strong> tickets
              </div>
              <div className="pagination-controls">
                <div className="page-size-selector">
                  <label>Rows:</label>
                  <select value={limit} onChange={(e) => { setLimit(Number(e.target.value)); setCurrentPage(1); }} className="page-size-select">
                    <option value={10}>10</option>
                    <option value={25}>25</option>
                    <option value={50}>50</option>
                    <option value={100}>100</option>
                  </select>
                </div>
                <div className="pagination-buttons">
                  <button className="btn-pagination" onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1}>
                    <ChevronLeft size={18} />
                  </button>
                  {[...Array(Math.min(5, totalPages))].map((_, idx) => {
                    let pageNum = totalPages <= 5 ? idx + 1 : currentPage <= 3 ? idx + 1 : currentPage >= totalPages - 2 ? totalPages - 4 + idx : currentPage - 2 + idx;
                    return (
                      <button key={pageNum} className={`btn-pagination ${currentPage === pageNum ? 'active' : ''}`} onClick={() => setCurrentPage(pageNum)}>
                        {pageNum}
                      </button>
                    );
                  })}
                  <button className="btn-pagination" onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages}>
                    <ChevronRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          </>
        )}
      </div>

      {activeDropdown && <div className="dropdown-overlay" onClick={() => setActiveDropdown(null)} />}
    </div>
  );
};

export default TicketsList;