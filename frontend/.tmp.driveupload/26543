/**
 * ============================================
 * TICKETS LIST PAGE - WITH ANIMATED BUCKETS
 * ============================================
 * Merged with MyTickets functionality
 * 
 * Features:
 * - Animated bucket selector (Created by Me / Assigned to Me)
 * - Role-based bucket visibility
 * - Table view with sorting, filtering, pagination
 * - SLA tracking and status management
 * - Export functionality
 * 
 * Developer: Suvadip Panja
 * Company: Digitide
 * Updated: February 2026
 * ============================================
 */

import { useState, useEffect, useCallback } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import {
  Search,
  Filter,
  Plus,
  RefreshCw,
  Download,
  Ticket,
  Tag,
  AlertTriangle,
  Clock,
  CheckCircle,
  AlertCircle,
  X,
  MoreVertical,
  Eye,
  Edit,
  Trash2,
  ChevronLeft,
  ChevronRight,
  User,
  UserCheck,
  Users,
  FileText,
  TrendingUp
} from 'lucide-react';
import api from '../../services/api';
import '../../styles/TicketsList.css';

const TicketsList = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const [searchParams, setSearchParams] = useSearchParams();

  // ============================================
  // BUCKET STATE (NEW - Merged from MyTickets)
  // ============================================
  const [activeBucket, setActiveBucket] = useState(searchParams.get('bucket') || 'all');
  const [bucketStats, setBucketStats] = useState({
    all: 0,
    created: 0,
    assigned: 0
  });

  // Check if user can see "Assigned to Me" bucket
  const canSeeAssignedBucket = ['Admin', 'Manager', 'IT Engineer', 'Engineer'].includes(user?.role_name) ||
    user?.permissions?.can_assign_tickets ||
    user?.permissions?.can_view_all_tickets;

  // Check if user is a normal user (only sees Created by Me)
  const isNormalUser = user?.role_name === 'User' && !user?.permissions?.can_view_all_tickets;

  // ============================================
  // EXISTING STATE
  // ============================================
  const [tickets, setTickets] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Pagination
  const [currentPage, setCurrentPage] = useState(1);
  const [limit, setLimit] = useState(10);
  const [totalRecords, setTotalRecords] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  
  // Sorting
  const [sortBy, setSortBy] = useState('created_at');
  const [sortOrder, setSortOrder] = useState('DESC');
  
  // Filters
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    search: '',
    status_id: '',
    priority_id: '',
    category_id: '',
    assigned_to: '',
    requester_id: '',
    sla_status: '',
    is_escalated: ''
  });
  
  // Lookup data
  const [statuses, setStatuses] = useState([]);
  const [priorities, setPriorities] = useState([]);
  const [categories, setCategories] = useState([]);
  const [engineers, setEngineers] = useState([]);
  
  // Dropdown
  const [activeDropdown, setActiveDropdown] = useState(null);

  // ============================================
  // FETCH DATA ON MOUNT & CHANGES
  // ============================================
  useEffect(() => {
    fetchLookupData();
  }, []);

  useEffect(() => {
    fetchTickets();
    fetchBucketStats();
  }, [currentPage, limit, sortBy, sortOrder, filters, activeBucket]);

  // Update URL when bucket changes
  useEffect(() => {
    if (activeBucket !== 'all') {
      setSearchParams({ bucket: activeBucket });
    } else {
      setSearchParams({});
    }
  }, [activeBucket]);

  // ============================================
  // FETCH LOOKUP DATA
  // ============================================
  const fetchLookupData = async () => {
    try {
      const [statusRes, priorityRes, categoryRes, engineerRes] = await Promise.all([
        api.get('/lookup/statuses'),
        api.get('/lookup/priorities'),
        api.get('/lookup/categories'),
        api.get('/users', { params: { role_name: 'Engineer', is_active: true, limit: 100 } })
      ]);

      setStatuses(statusRes.data.data || []);
      setPriorities(priorityRes.data.data || []);
      setCategories(categoryRes.data.data || []);
      setEngineers(engineerRes.data.data?.users || engineerRes.data.data || []);
    } catch (err) {
      console.error('Error fetching lookup data:', err);
    }
  };

  // ============================================
  // FETCH BUCKET STATS (NEW)
  // ============================================
  const fetchBucketStats = async () => {
    try {
      // Fetch counts for each bucket
      const params = {};
      
      // All tickets (based on role)
      const allRes = await api.get('/tickets', { 
        params: { limit: 1, page: 1 } 
      });
      
      // Created by me
      const createdRes = await api.get('/tickets', { 
        params: { limit: 1, page: 1, requester_id: user?.user_id } 
      });
      
      // Assigned to me (only if can see)
      let assignedCount = 0;
      if (canSeeAssignedBucket) {
        const assignedRes = await api.get('/tickets', { 
          params: { limit: 1, page: 1, assigned_to: user?.user_id } 
        });
        assignedCount = assignedRes.data.data?.pagination?.total || 
                        assignedRes.data.pagination?.total || 0;
      }

      setBucketStats({
        all: allRes.data.data?.pagination?.total || allRes.data.pagination?.total || 0,
        created: createdRes.data.data?.pagination?.total || createdRes.data.pagination?.total || 0,
        assigned: assignedCount
      });
    } catch (err) {
      console.error('Error fetching bucket stats:', err);
    }
  };

  // ============================================
  // FETCH TICKETS
  // ============================================
  const fetchTickets = async () => {
    try {
      setLoading(true);
      setError('');

      const params = {
        page: currentPage,
        limit: limit,
        sortBy: sortBy,
        sortOrder: sortOrder,
        ...Object.fromEntries(
          Object.entries(filters).filter(([_, value]) => value !== '')
        )
      };

      // Apply bucket filtering
      if (activeBucket === 'created') {
        params.requester_id = user?.user_id;
      } else if (activeBucket === 'assigned' && canSeeAssignedBucket) {
        params.assigned_to = user?.user_id;
      } else if (activeBucket === 'all') {
        // Apply role-based filtering for "All" bucket
        if (isNormalUser) {
          params.requester_id = user?.user_id;
        } else if (user?.role_name === 'Engineer' && !user?.permissions?.can_view_all_tickets) {
          params.assigned_to_or_created_by = user?.user_id;
        }
      }

      console.log('ðŸ“¤ Fetching tickets with params:', params);

      const response = await api.get('/tickets', { params });

      console.log('ðŸ“¥ Full API Response:', response.data);

      if (response.data.success) {
        const responseData = response.data.data;
        const ticketsData = responseData?.tickets || responseData || [];
        const paginationData = responseData?.pagination || response.data.pagination || {};
        
        const ticketsArray = Array.isArray(ticketsData) ? ticketsData : [];
        
        setTickets(ticketsArray);
        setTotalRecords(paginationData.total || ticketsArray.length);
        setTotalPages(paginationData.totalPages || Math.ceil((paginationData.total || ticketsArray.length) / limit));
      }
    } catch (err) {
      console.error('âŒ Error fetching tickets:', err);
      setError(err.response?.data?.message || 'Failed to load tickets');
    } finally {
      setLoading(false);
    }
  };

  // ============================================
  // BUCKET CHANGE HANDLER (NEW)
  // ============================================
  const handleBucketChange = (bucket) => {
    if (bucket === 'assigned' && !canSeeAssignedBucket) return;
    setActiveBucket(bucket);
    setCurrentPage(1);
    // Reset filters when changing bucket
    setFilters(prev => ({
      ...prev,
      assigned_to: '',
      requester_id: ''
    }));
  };

  // ============================================
  // EXPORT TICKETS
  // ============================================
  const exportTickets = async () => {
    try {
      const params = {
        sortBy,
        sortOrder,
        ...Object.fromEntries(
          Object.entries(filters).filter(([_, value]) => value !== '')
        )
      };

      // Apply bucket filtering for export
      if (activeBucket === 'created') {
        params.requester_id = user?.user_id;
      } else if (activeBucket === 'assigned') {
        params.assigned_to = user?.user_id;
      }

      const response = await api.get('/tickets/export', { 
        params,
        responseType: 'blob'
      });

      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `tickets_${activeBucket}_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);

      console.log('âœ… Export successful', { count: tickets.length });
    } catch (err) {
      console.error('âŒ Error exporting tickets:', err);
      alert('Failed to export tickets. Please try again.');
    }
  };

  // ============================================
  // FILTER HANDLERS
  // ============================================
  const handleFilterChange = (field, value) => {
    setFilters(prev => ({
      ...prev,
      [field]: value
    }));
    setCurrentPage(1);
  };

  const handleSearch = (e) => {
    const value = e.target.value;
    handleFilterChange('search', value);
  };

  const clearFilters = () => {
    setFilters({
      search: '',
      status_id: '',
      priority_id: '',
      category_id: '',
      assigned_to: '',
      requester_id: '',
      sla_status: '',
      is_escalated: ''
    });
    setCurrentPage(1);
  };

  // ============================================
  // SORT HANDLER
  // ============================================
  const handleSort = (field) => {
    if (sortBy === field) {
      setSortOrder(sortOrder === 'ASC' ? 'DESC' : 'ASC');
    } else {
      setSortBy(field);
      setSortOrder('DESC');
    }
  };

  // ============================================
  // NAVIGATION HANDLERS
  // ============================================
  const viewTicket = (ticketId) => {
    navigate(`/tickets/${ticketId}`);
  };

  const editTicket = (ticketId) => {
    navigate(`/tickets/edit/${ticketId}`);
  };

  const deleteTicket = async (ticketId) => {
    if (!window.confirm('Are you sure you want to delete this ticket?')) {
      return;
    }

    try {
      await api.delete(`/tickets/${ticketId}`);
      fetchTickets();
      fetchBucketStats();
    } catch (err) {
      console.error('Error deleting ticket:', err);
      alert(err.response?.data?.message || 'Failed to delete ticket');
    }
  };

  const toggleDropdown = (ticketId) => {
    setActiveDropdown(activeDropdown === ticketId ? null : ticketId);
  };

  // ============================================
  // HELPER FUNCTIONS
  // ============================================
  const getStatusBadgeClass = (statusCode) => {
    const classes = {
      'OPEN': 'status-open',
      'IN_PROGRESS': 'status-progress',
      'PENDING': 'status-pending',
      'ON_HOLD': 'status-on-hold',
      'RESOLVED': 'status-resolved',
      'CLOSED': 'status-closed',
      'ESCALATED': 'status-escalated',
      'CANCELLED': 'status-cancelled'
    };
    return classes[statusCode] || 'status-default';
  };

  const getPriorityBadgeClass = (priorityCode) => {
    const classes = {
      'CRITICAL': 'priority-critical',
      'HIGH': 'priority-high',
      'MEDIUM': 'priority-medium',
      'LOW': 'priority-low',
      'PLANNING': 'priority-planning'
    };
    return classes[priorityCode] || 'priority-default';
  };

  const formatDate = (dateString) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      if (diffHours === 0) {
        const diffMins = Math.floor(diffMs / (1000 * 60));
        return diffMins <= 1 ? 'Just now' : `${diffMins}m ago`;
      }
      return `${diffHours}h ago`;
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return `${diffDays}d ago`;
    }
    
    return date.toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short',
      year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
  };

  // ============================================
  // SLA HELPER FUNCTIONS
  // ============================================
  const calculateSlaStatus = (ticket) => {
    if (!ticket.due_date) {
      return { status: 'none', label: 'No SLA', color: '#94a3b8', percentage: 0 };
    }

    const now = new Date();
    const dueDate = new Date(ticket.due_date);
    const createdAt = new Date(ticket.created_at);
    
    // If ticket is resolved/closed
    if (ticket.status_code === 'RESOLVED' || ticket.status_code === 'CLOSED') {
      if (ticket.resolved_at) {
        const resolvedAt = new Date(ticket.resolved_at);
        if (resolvedAt <= dueDate) {
          return { status: 'met', label: 'SLA Met', color: '#10b981', percentage: 100 };
        } else {
          return { status: 'breached', label: 'SLA Breached', color: '#ef4444', percentage: 100 };
        }
      }
    }
    
    const totalTime = dueDate - createdAt;
    const elapsedTime = now - createdAt;
    const percentage = Math.min((elapsedTime / totalTime) * 100, 100);
    
    if (now > dueDate) {
      return { status: 'breached', label: 'Breached', color: '#ef4444', percentage: 100 };
    } else if (percentage >= 80) {
      return { status: 'warning', label: 'At Risk', color: '#f59e0b', percentage };
    } else {
      return { status: 'ok', label: 'On Track', color: '#10b981', percentage };
    }
  };

  const formatTimeRemaining = (ticket) => {
    if (!ticket.due_date) return '-';
    
    const now = new Date();
    const dueDate = new Date(ticket.due_date);
    const diff = dueDate - now;
    
    if (diff < 0) {
      const overdue = Math.abs(diff);
      const hours = Math.floor(overdue / (1000 * 60 * 60));
      if (hours < 24) return `${hours}h overdue`;
      const days = Math.floor(hours / 24);
      return `${days}d overdue`;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    if (hours < 24) return `${hours}h left`;
    const days = Math.floor(hours / 24);
    return `${days}d ${hours % 24}h left`;
  };

  const getSLAProgressBar = (ticket) => {
    const sla = calculateSlaStatus(ticket);
    
    if (sla.status === 'none') {
      return <span className="text-muted">No SLA</span>;
    }

    return (
      <div className="sla-progress-wrapper">
        <div className="sla-progress-bar">
          <div 
            className="sla-progress-fill"
            style={{ 
              width: `${Math.min(sla.percentage, 100)}%`,
              backgroundColor: sla.color 
            }}
          />
        </div>
        <span className="sla-progress-text" style={{ color: sla.color }}>
          {Math.round(sla.percentage)}%
        </span>
      </div>
    );
  };

  // Check if user can edit ticket
  const canEditTicket = (ticket) => {
    if (user?.permissions?.can_assign_tickets) return true;
    if (ticket.requester_id === user?.user_id) return true;
    if (ticket.assigned_to === user?.user_id) return true;
    return false;
  };

  // Get active filter count
  const getActiveFilterCount = () => {
    return Object.values(filters).filter(v => v !== '').length;
  };

  // ============================================
  // RENDER
  // ============================================
  return (
    <div className="tickets-page">
      {/* Page Header */}
      <div className="page-header">
        <div className="header-left">
          <div className="page-title-wrapper">
            <div className="page-icon-wrapper">
              <Ticket size={28} className="page-icon" />
            </div>
            <div>
              <h1 className="page-title">Support Tickets</h1>
              <p className="page-subtitle">
                {totalRecords > 0 ? `${totalRecords} ticket${totalRecords !== 1 ? 's' : ''} found` : 'No tickets available'}
              </p>
            </div>
          </div>
        </div>
        <div className="header-right">
          <button 
            className="btn-icon-action" 
            onClick={() => { fetchTickets(); fetchBucketStats(); }} 
            title="Refresh"
            disabled={loading}
          >
            <RefreshCw size={18} className={loading ? 'spinning' : ''} />
          </button>
          <button 
            className="btn-icon-action" 
            onClick={exportTickets}
            title="Export to CSV"
            disabled={loading || tickets.length === 0}
          >
            <Download size={18} />
          </button>
          {user?.permissions?.can_create_tickets && (
            <button 
              className="btn-primary-action"
              onClick={() => navigate('/tickets/create')}
            >
              <Plus size={20} />
              <span>Create Ticket</span>
            </button>
          )}
        </div>
      </div>

      {/* ============================================
          ANIMATED BUCKETS SECTION (NEW)
          ============================================ */}
      <div className="buckets-container">
        {/* All Tickets Bucket - Only for Admin/Manager/Engineer */}
        {!isNormalUser && (
          <div 
            className={`bucket ${activeBucket === 'all' ? 'active' : ''}`}
            onClick={() => handleBucketChange('all')}
          >
            <div className="bucket-icon">
              <Users size={24} />
            </div>
            <div className="bucket-content">
              <span className="bucket-label">All Tickets</span>
              <span className="bucket-count">{bucketStats.all}</span>
            </div>
            <div className="bucket-wave"></div>
            <div className="bucket-glow"></div>
          </div>
        )}
        
        {/* Created by Me Bucket - Visible to all */}
        <div 
          className={`bucket ${activeBucket === 'created' ? 'active' : ''}`}
          onClick={() => handleBucketChange('created')}
        >
          <div className="bucket-icon">
            <User size={24} />
          </div>
          <div className="bucket-content">
            <span className="bucket-label">Created by Me</span>
            <span className="bucket-count">{bucketStats.created}</span>
          </div>
          <div className="bucket-wave"></div>
          <div className="bucket-glow"></div>
        </div>
        
        {/* Assigned to Me Bucket - Only for IT staff */}
        {canSeeAssignedBucket && (
          <div 
            className={`bucket ${activeBucket === 'assigned' ? 'active' : ''}`}
            onClick={() => handleBucketChange('assigned')}
          >
            <div className="bucket-icon">
              <UserCheck size={24} />
            </div>
            <div className="bucket-content">
              <span className="bucket-label">Assigned to Me</span>
              <span className="bucket-count">{bucketStats.assigned}</span>
            </div>
            <div className="bucket-wave"></div>
            <div className="bucket-glow"></div>
          </div>
        )}
      </div>

      {/* Search and Filter Bar */}
      <div className="filter-section">
        <div className="search-wrapper">
          <Search size={18} className="search-icon" />
          <input
            type="text"
            placeholder="Search by ticket #, title, or requester..."
            className="search-input-large"
            value={filters.search}
            onChange={handleSearch}
          />
          {filters.search && (
            <button 
              className="search-clear-btn"
              onClick={() => handleFilterChange('search', '')}
            >
              <X size={16} />
            </button>
          )}
        </div>

        <div className="filter-actions">
          <button 
            className={`btn-filter ${showFilters ? 'active' : ''}`}
            onClick={() => setShowFilters(!showFilters)}
          >
            <Filter size={18} />
            <span>Filters</span>
            {getActiveFilterCount() > 0 && (
              <span className="filter-count">
                {getActiveFilterCount()}
              </span>
            )}
          </button>

          {getActiveFilterCount() > 0 && (
            <button className="btn-clear-filters" onClick={clearFilters}>
              <X size={16} />
              Clear All
            </button>
          )}
        </div>
      </div>

      {/* Advanced Filters Panel */}
      {showFilters && (
        <div className="filters-panel">
          <div className="filters-grid">
            {/* Status Filter */}
            <div className="filter-item">
              <label className="filter-label">
                <Tag size={14} />
                Status
              </label>
              <select
                value={filters.status_id}
                onChange={(e) => handleFilterChange('status_id', e.target.value)}
                className="filter-select"
              >
                <option value="">All Statuses</option>
                {statuses.map((status) => (
                  <option key={status.status_id} value={status.status_id}>
                    {status.status_name}
                  </option>
                ))}
              </select>
            </div>

            {/* Priority Filter */}
            <div className="filter-item">
              <label className="filter-label">
                <AlertTriangle size={14} />
                Priority
              </label>
              <select
                value={filters.priority_id}
                onChange={(e) => handleFilterChange('priority_id', e.target.value)}
                className="filter-select"
              >
                <option value="">All Priorities</option>
                {priorities.map((priority) => (
                  <option key={priority.priority_id} value={priority.priority_id}>
                    {priority.priority_name}
                  </option>
                ))}
              </select>
            </div>

            {/* Category Filter */}
            <div className="filter-item">
              <label className="filter-label">
                <Ticket size={14} />
                Category
              </label>
              <select
                value={filters.category_id}
                onChange={(e) => handleFilterChange('category_id', e.target.value)}
                className="filter-select"
              >
                <option value="">All Categories</option>
                {categories.map((category) => (
                  <option key={category.category_id} value={category.category_id}>
                    {category.category_name}
                  </option>
                ))}
              </select>
            </div>

            {/* Assigned To Filter - Only for managers/admins and only in "All" bucket */}
            {(user?.permissions?.can_assign_tickets || user?.permissions?.can_view_all_tickets) && activeBucket === 'all' && (
              <div className="filter-item">
                <label className="filter-label">
                  <User size={14} />
                  Assigned To
                </label>
                <select
                  value={filters.assigned_to}
                  onChange={(e) => handleFilterChange('assigned_to', e.target.value)}
                  className="filter-select"
                >
                  <option value="">All Engineers</option>
                  <option value="unassigned">Unassigned</option>
                  {engineers.map((engineer) => (
                    <option key={engineer.user_id} value={engineer.user_id}>
                      {engineer.full_name}
                    </option>
                  ))}
                </select>
              </div>
            )}

            {/* SLA Status Filter */}
            <div className="filter-item">
              <label className="filter-label">
                <Clock size={14} />
                SLA Status
              </label>
              <select
                value={filters.sla_status}
                onChange={(e) => handleFilterChange('sla_status', e.target.value)}
                className="filter-select"
              >
                <option value="">All SLA Status</option>
                <option value="ok">ðŸŸ¢ On Track</option>
                <option value="warning">ðŸŸ¡ At Risk</option>
                <option value="breached">ðŸ”´ Breached</option>
                <option value="none">âšª No SLA</option>
              </select>
            </div>

            {/* Escalated Filter */}
            <div className="filter-item">
              <label className="filter-label">
                <AlertCircle size={14} />
                Escalated
              </label>
              <select
                value={filters.is_escalated}
                onChange={(e) => handleFilterChange('is_escalated', e.target.value)}
                className="filter-select"
              >
                <option value="">All Tickets</option>
                <option value="true">Escalated Only</option>
                <option value="false">Not Escalated</option>
              </select>
            </div>
          </div>

          {/* Active Filter Chips */}
          {getActiveFilterCount() > 0 && (
            <div className="active-filters">
              <span className="active-filters-label">Active Filters:</span>
              <div className="filter-chips">
                {filters.status_id && (
                  <div className="filter-chip">
                    <span>Status: {statuses.find(s => s.status_id === parseInt(filters.status_id))?.status_name}</span>
                    <button onClick={() => handleFilterChange('status_id', '')}>
                      <X size={12} />
                    </button>
                  </div>
                )}
                {filters.priority_id && (
                  <div className="filter-chip">
                    <span>Priority: {priorities.find(p => p.priority_id === parseInt(filters.priority_id))?.priority_name}</span>
                    <button onClick={() => handleFilterChange('priority_id', '')}>
                      <X size={12} />
                    </button>
                  </div>
                )}
                {filters.category_id && (
                  <div className="filter-chip">
                    <span>Category: {categories.find(c => c.category_id === parseInt(filters.category_id))?.category_name}</span>
                    <button onClick={() => handleFilterChange('category_id', '')}>
                      <X size={12} />
                    </button>
                  </div>
                )}
                {filters.assigned_to && (
                  <div className="filter-chip">
                    <span>
                      Assigned: {filters.assigned_to === 'unassigned' 
                        ? 'Unassigned' 
                        : engineers.find(e => e.user_id === parseInt(filters.assigned_to))?.full_name || 'Unknown'}
                    </span>
                    <button onClick={() => handleFilterChange('assigned_to', '')}>
                      <X size={12} />
                    </button>
                  </div>
                )}
                {filters.sla_status && (
                  <div className="filter-chip">
                    <span>SLA: {filters.sla_status === 'ok' ? 'ðŸŸ¢ On Track' : filters.sla_status === 'warning' ? 'ðŸŸ¡ At Risk' : filters.sla_status === 'breached' ? 'ðŸ”´ Breached' : 'âšª No SLA'}</span>
                    <button onClick={() => handleFilterChange('sla_status', '')}>
                      <X size={12} />
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Error Message */}
      {error && (
        <div className="alert alert-error">
          <AlertCircle size={20} />
          <span>{error}</span>
          <button onClick={() => setError('')} className="alert-close">
            <X size={16} />
          </button>
        </div>
      )}

      {/* Tickets Table */}
      <div className="table-container">
        {loading ? (
          <div className="loading-state">
            <div className="spinner"></div>
            <p>Loading tickets...</p>
          </div>
        ) : tickets.length === 0 ? (
          <div className="empty-state">
            <div className="empty-icon-wrapper">
              <Ticket size={64} className="empty-icon" />
            </div>
            <h3>No tickets found</h3>
            <p className="empty-description">
              {getActiveFilterCount() > 0
                ? 'No tickets match your current filters. Try adjusting or clearing them.'
                : activeBucket === 'created'
                ? "You haven't created any tickets yet. Create your first ticket to get started."
                : activeBucket === 'assigned'
                ? "No tickets are currently assigned to you."
                : user?.role_name === 'User'
                ? "You haven't created any tickets yet. Create your first ticket to get started."
                : 'No tickets are available in the system yet.'}
            </p>
            {user?.permissions?.can_create_tickets && activeBucket !== 'assigned' && (
              <button
                className="btn-primary-action"
                onClick={() => navigate('/tickets/create')}
              >
                <Plus size={20} />
                <span>Create First Ticket</span>
              </button>
            )}
          </div>
        ) : (
          <>
            <div className="table-wrapper">
              <table className="tickets-table">
                <thead>
                  <tr>
                    <th 
                      onClick={() => handleSort('ticket_number')} 
                      className="sortable th-ticket-number"
                    >
                      <div className="th-content">
                        <span>Ticket #</span>
                        {sortBy === 'ticket_number' && (
                          <span className="sort-indicator">
                            {sortOrder === 'ASC' ? 'â†‘' : 'â†“'}
                          </span>
                        )}
                      </div>
                    </th>
                    <th 
                      onClick={() => handleSort('subject')} 
                      className="sortable th-title"
                    >
                      <div className="th-content">
                        <span>Title & Details</span>
                        {sortBy === 'subject' && (
                          <span className="sort-indicator">
                            {sortOrder === 'ASC' ? 'â†‘' : 'â†“'}
                          </span>
                        )}
                      </div>
                    </th>
                    <th className="th-category">Category</th>
                    <th 
                      onClick={() => handleSort('priority_level')} 
                      className="sortable th-priority"
                    >
                      <div className="th-content">
                        <span>Priority</span>
                        {sortBy === 'priority_level' && (
                          <span className="sort-indicator">
                            {sortOrder === 'ASC' ? 'â†‘' : 'â†“'}
                          </span>
                        )}
                      </div>
                    </th>
                    <th 
                      onClick={() => handleSort('status_id')} 
                      className="sortable th-status"
                    >
                      <div className="th-content">
                        <span>Status</span>
                        {sortBy === 'status_id' && (
                          <span className="sort-indicator">
                            {sortOrder === 'ASC' ? 'â†‘' : 'â†“'}
                          </span>
                        )}
                      </div>
                    </th>
                    {/* Show Requester column only in "All" or "Assigned" bucket */}
                    {(activeBucket === 'all' || activeBucket === 'assigned') && (
                      <th className="th-requester">Requester</th>
                    )}
                    {/* Show Assigned To column only in "All" or "Created" bucket */}
                    {(activeBucket === 'all' || activeBucket === 'created') && (
                      <th className="th-assigned">Assigned To</th>
                    )}
                    <th 
                      onClick={() => handleSort('created_at')} 
                      className="sortable th-created"
                    >
                      <div className="th-content">
                        <span>Created</span>
                        {sortBy === 'created_at' && (
                          <span className="sort-indicator">
                            {sortOrder === 'ASC' ? 'â†‘' : 'â†“'}
                          </span>
                        )}
                      </div>
                    </th>
                    <th className="th-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {tickets.map((ticket) => {
                    const sla = calculateSlaStatus(ticket);
                    
                    return (
                      <tr 
                        key={ticket.ticket_id}
                        className={ticket.is_escalated ? 'escalated' : ''}
                        onClick={() => viewTicket(ticket.ticket_id)}
                      >
                        <td>
                          <div className="ticket-number-wrapper">
                            {ticket.is_escalated && (
                              <AlertTriangle size={14} className="escalated-icon" title="Escalated" />
                            )}
                            <span className="ticket-number">#{ticket.ticket_number}</span>
                          </div>
                        </td>
                        <td>
                          <div className="ticket-title-wrapper">
                            <span className="ticket-title">{ticket.subject || ticket.title || 'No Title'}</span>
                            {ticket.description && (
                              <span className="ticket-desc">
                                {ticket.description.substring(0, 60)}...
                              </span>
                            )}
                          </div>
                        </td>
                        <td>
                          <span className="category-badge">
                            {ticket.category_name || '-'}
                          </span>
                        </td>
                        <td>
                          <span className={`priority-badge ${getPriorityBadgeClass(ticket.priority_code)}`}>
                            {ticket.priority_name}
                          </span>
                        </td>
                        <td>
                          <span className={`status-badge ${getStatusBadgeClass(ticket.status_code)}`}>
                            {ticket.status_name}
                          </span>
                        </td>
                        {/* Requester column */}
                        {(activeBucket === 'all' || activeBucket === 'assigned') && (
                          <td>
                            <div className="user-cell">
                              {ticket.requester_avatar || ticket.requester_profile_picture ? (
                                <img 
                                  src={ticket.requester_avatar || ticket.requester_profile_picture || '/assets/images/default-avatar.png'} 
                                  alt="" 
                                  className="user-avatar-small"
                                />
                              ) : (
                                <div className="user-avatar-placeholder">
                                  {ticket.requester_name?.charAt(0) || '?'}
                                </div>
                              )}
                              <span>{ticket.requester_name || '-'}</span>
                            </div>
                          </td>
                        )}
                        {/* Assigned To column */}
                        {(activeBucket === 'all' || activeBucket === 'created') && (
                          <td>
                            <div className="user-cell">
                              {ticket.assigned_to_name ? (
                                <>
                                  {ticket.assigned_to_avatar || ticket.assigned_to_profile_picture ? (
                                    <img 
                                      src={ticket.assigned_to_avatar || ticket.assigned_to_profile_picture || '/assets/images/default-avatar.png'} 
                                      alt="" 
                                      className="user-avatar-small"
                                    />
                                  ) : (
                                    <div className="user-avatar-placeholder">
                                      {ticket.assigned_to_name?.charAt(0) || '?'}
                                    </div>
                                  )}
                                  <span>{ticket.assigned_to_name}</span>
                                </>
                              ) : (
                                <span className="unassigned">Unassigned</span>
                              )}
                            </div>
                          </td>
                        )}
                        <td>
                          <div className="date-cell">
                            <span className="date-primary">{formatDate(ticket.created_at)}</span>
                          </div>
                        </td>
                        <td className="actions-cell" onClick={(e) => e.stopPropagation()}>
                          <div className="action-buttons">
                            <button
                              className="btn-action-icon"
                              onClick={() => viewTicket(ticket.ticket_id)}
                              title="View Details"
                            >
                              <Eye size={16} />
                            </button>
                            {canEditTicket(ticket) && (
                              <button
                                className="btn-action-icon"
                                onClick={() => editTicket(ticket.ticket_id)}
                                title="Edit Ticket"
                              >
                                <Edit size={16} />
                              </button>
                            )}
                            <div className="dropdown-container">
                              <button
                                className="btn-action-icon"
                                onClick={() => toggleDropdown(ticket.ticket_id)}
                                title="More Options"
                              >
                                <MoreVertical size={16} />
                              </button>
                              {activeDropdown === ticket.ticket_id && (
                                <div className="dropdown-menu">
                                  <button 
                                    className="dropdown-item"
                                    onClick={() => {
                                      viewTicket(ticket.ticket_id);
                                      setActiveDropdown(null);
                                    }}
                                  >
                                    <Eye size={14} />
                                    <span>View Details</span>
                                  </button>
                                  {canEditTicket(ticket) && (
                                    <button 
                                      className="dropdown-item"
                                      onClick={() => {
                                        editTicket(ticket.ticket_id);
                                        setActiveDropdown(null);
                                      }}
                                    >
                                      <Edit size={14} />
                                      <span>Edit Ticket</span>
                                    </button>
                                  )}
                                  {user?.permissions?.can_delete_tickets && (
                                    <>
                                      <div className="dropdown-divider"></div>
                                      <button 
                                        className="dropdown-item danger"
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          deleteTicket(ticket.ticket_id);
                                          setActiveDropdown(null);
                                        }}
                                      >
                                        <Trash2 size={14} />
                                        <span>Delete Ticket</span>
                                      </button>
                                    </>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            <div className="pagination-container">
              <div className="pagination-info">
                Showing <strong>{((currentPage - 1) * limit) + 1}</strong> to{' '}
                <strong>{Math.min(currentPage * limit, totalRecords)}</strong> of{' '}
                <strong>{totalRecords}</strong> ticket{totalRecords !== 1 ? 's' : ''}
              </div>

              <div className="pagination-controls">
                <div className="page-size-selector">
                  <label>Rows per page:</label>
                  <select
                    value={limit}
                    onChange={(e) => {
                      setLimit(Number(e.target.value));
                      setCurrentPage(1);
                    }}
                    className="page-size-select"
                  >
                    <option value={10}>10</option>
                    <option value={25}>25</option>
                    <option value={50}>50</option>
                    <option value={100}>100</option>
                  </select>
                </div>

                <div className="pagination-buttons">
                  <button
                    className="btn-pagination"
                    onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                    disabled={currentPage === 1}
                    title="Previous Page"
                  >
                    <ChevronLeft size={18} />
                  </button>

                  {[...Array(Math.min(5, totalPages))].map((_, idx) => {
                    let pageNum;
                    if (totalPages <= 5) {
                      pageNum = idx + 1;
                    } else if (currentPage <= 3) {
                      pageNum = idx + 1;
                    } else if (currentPage >= totalPages - 2) {
                      pageNum = totalPages - 4 + idx;
                    } else {
                      pageNum = currentPage - 2 + idx;
                    }

                    return (
                      <button
                        key={pageNum}
                        className={`btn-pagination ${currentPage === pageNum ? 'active' : ''}`}
                        onClick={() => setCurrentPage(pageNum)}
                      >
                        {pageNum}
                      </button>
                    );
                  })}

                  <button
                    className="btn-pagination"
                    onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                    disabled={currentPage === totalPages}
                    title="Next Page"
                  >
                    <ChevronRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          </>
        )}
      </div>

      {/* Click outside to close dropdown */}
      {activeDropdown && (
        <div 
          className="dropdown-overlay" 
          onClick={() => setActiveDropdown(null)}
        />
      )}
    </div>
  );
};

export default TicketsList;