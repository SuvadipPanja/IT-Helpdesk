import { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Download,
  Send,
  Paperclip,
  User,
  Clock,
  AlertCircle,
  CheckCircle,
  AlertTriangle,
  Calendar,
  Tag,
  MessageSquare,
  Activity,
  Upload,
  FileText,
  Image as ImageIcon,
  File,
  X,
  Eye,
  EyeOff,
  MoreVertical,
  RefreshCw,
  UserCheck,
  TrendingUp,
  XCircle
} from 'lucide-react';
import api from '../../services/api';
import '../../styles/TicketDetail.css';

const TicketDetail = () => {
  const { id } = useParams();
  const { user } = useAuth();
  const navigate = useNavigate();

  // State management
  const [ticket, setTicket] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Comments state
  const [comments, setComments] = useState([]);
  const [newComment, setNewComment] = useState('');
  const [isInternalNote, setIsInternalNote] = useState(false);
  const [commentLoading, setCommentLoading] = useState(false);

  // Activities state
  const [activities, setActivities] = useState([]);

  // Attachments state
  const [attachments, setAttachments] = useState([]);

  // Assignment state
  const [engineers, setEngineers] = useState([]);
  const [selectedEngineer, setSelectedEngineer] = useState('');
  const [assignLoading, setAssignLoading] = useState(false);

  // UI state
  const [activeTab, setActiveTab] = useState('comments');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  // Fetch engineers on mount
  useEffect(() => {
    fetchEngineers();
  }, []);

  // Fetch ticket details on mount
  useEffect(() => {
    if (id) {
      fetchTicketDetails();
    }
  }, [id]);

  // Fetch engineers list
  const fetchEngineers = async () => {
    try {
      const response = await api.get('/system/engineers');
      if (response.data.success) {
        setEngineers(response.data.data);
      }
    } catch (err) {
      console.error('Error fetching engineers:', err);
    }
  };

  // Fetch ticket details
  const fetchTicketDetails = async () => {
    try {
      setLoading(true);
      setError('');

      const response = await api.get(`/tickets/${id}`);

      if (response.data.success) {
        const ticketData = response.data.data;
        setTicket(ticketData);
        setComments(ticketData.comments || []);
        setActivities(ticketData.activities || []);
        setAttachments(ticketData.attachments || []);
        
        // Set currently assigned engineer in dropdown
        if (ticketData.assigned_to_id) {
          setSelectedEngineer(ticketData.assigned_to_id.toString());
        }
      } else {
        setError('Ticket not found');
      }
    } catch (err) {
      console.error('Error fetching ticket:', err);
      setError(err.response?.data?.message || 'Failed to load ticket details');
    } finally {
      setLoading(false);
    }
  };

  // Add comment
  const handleAddComment = async () => {
    if (!newComment.trim()) {
      return;
    }

    try {
      setCommentLoading(true);

      const response = await api.post(`/tickets/${id}/comments`, {
        comment_text: newComment,
        is_internal: isInternalNote
      });

      if (response.data.success) {
        // Clear form
        setNewComment('');
        setIsInternalNote(false);

        // Refresh ticket to get updated data
        fetchTicketDetails();
      }
    } catch (err) {
      console.error('Error adding comment:', err);
      alert(err.response?.data?.message || 'Failed to add comment');
    } finally {
      setCommentLoading(false);
    }
  };

  // Assign engineer
  const handleAssignEngineer = async () => {
    if (!selectedEngineer) {
      alert('Please select an engineer to assign');
      return;
    }

    try {
      setAssignLoading(true);

      const response = await api.patch(`/tickets/${id}/assign`, {
        assigned_to: parseInt(selectedEngineer)
      });

      if (response.data.success) {
        alert('Ticket assigned successfully!');
        // Refresh ticket details
        fetchTicketDetails();
      }
    } catch (err) {
      console.error('Error assigning ticket:', err);
      alert(err.response?.data?.message || 'Failed to assign ticket');
    } finally {
      setAssignLoading(false);
    }
  };

  // Delete ticket
  const handleDeleteTicket = async () => {
    try {
      const response = await api.delete(`/tickets/${id}`);
      
      if (response.data.success) {
        alert('Ticket deleted successfully!');
        navigate('/tickets');
      }
    } catch (err) {
      console.error('Error deleting ticket:', err);
      alert(err.response?.data?.message || 'Failed to delete ticket');
      setShowDeleteConfirm(false);
    }
  };

  // Navigate to edit - ‚≠ê ORIGINAL ROUTE PRESERVED
  const handleEditTicket = () => {
    navigate(`/tickets/edit/${id}`);
  };

  // Close ticket - Quick action for assigned engineer/admin
  // Developer: Suvadip Panja
  // Date: February 04, 2026
  const [closeLoading, setCloseLoading] = useState(false);
  
  const handleCloseTicket = async () => {
    if (!window.confirm('Are you sure you want to close this ticket?')) {
      return;
    }

    try {
      setCloseLoading(true);

      const response = await api.patch(`/tickets/${id}`, {
        status_code: 'CLOSED'
      });

      if (response.data.success) {
        alert('Ticket closed successfully!');
        // Refresh ticket details to show updated status
        fetchTicketDetails();
      }
    } catch (err) {
      console.error('Error closing ticket:', err);
      alert(err.response?.data?.message || 'Failed to close ticket');
    } finally {
      setCloseLoading(false);
    }
  };

  // Format date
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      const hoursStr = String(hours).padStart(2, '0');
      
      return `${day}/${month}/${year} ${hoursStr}:${minutes} ${ampm}`;
    } catch {
      return 'Invalid Date';
    }
  };

  // Get status color class
  const getStatusColor = (status) => {
    const colors = {
      'OPEN': 'status-open',
      'IN_PROGRESS': 'status-progress',
      'PENDING': 'status-pending',
      'ON_HOLD': 'status-hold',
      'RESOLVED': 'status-resolved',
      'CLOSED': 'status-closed',
      'CANCELLED': 'status-cancelled'
    };
    return colors[status] || 'status-default';
  };

  // Get priority color class
  const getPriorityColor = (priority) => {
    const colors = {
      'CRITICAL': 'priority-critical',
      'HIGH': 'priority-high',
      'MEDIUM': 'priority-medium',
      'LOW': 'priority-low',
      'PLANNING': 'priority-planning'
    };
    return colors[priority] || 'priority-default';
  };

  // Get status icon
  const getStatusIcon = (status) => {
    const icons = {
      'OPEN': AlertCircle,
      'IN_PROGRESS': Clock,
      'PENDING': Clock,
      'ON_HOLD': Clock,
      'RESOLVED': CheckCircle,
      'CLOSED': CheckCircle,
      'CANCELLED': X
    };
    const Icon = icons[status] || AlertCircle;
    return <Icon size={20} />;
  };

  // ============================================
  // ‚≠ê PHASE 3 FIX: SLA HELPER FUNCTIONS
  // ============================================
  
  // Calculate SLA percentage and status
  const calculateSlaStatus = (ticket) => {
    if (!ticket.due_date || !ticket.created_at) {
      return { 
        status: 'none', 
        percentage: 0, 
        color: '#94a3b8', 
        label: 'No SLA',
        isClosed: false 
      };
    }

    const now = new Date();
    const created = new Date(ticket.created_at);
    const due = new Date(ticket.due_date);
    const resolved = ticket.resolved_at ? new Date(ticket.resolved_at) : null;
    
    // Check if ticket is closed
    const isClosed = ticket.is_final_status || 
                     ticket.status_code === 'RESOLVED' || 
                     ticket.status_code === 'CLOSED';
    
    // For closed tickets, show final status
    if (isClosed) {
      const resolvedAt = resolved || now;
      const wasMet = resolvedAt <= due;
      
      if (wasMet) {
        return {
          status: 'met',
          percentage: 100,
          color: '#10b981',
          label: 'SLA Met',
          isClosed: true,
          resolvedAt: resolvedAt,
          dueDate: due
        };
      } else {
        return {
          status: 'breached',
          percentage: 100,
          color: '#ef4444',
          label: 'SLA Breached',
          isClosed: true,
          resolvedAt: resolvedAt,
          dueDate: due
        };
      }
    }
    
    // For open tickets, calculate progress
    const totalTime = due - created;
    const elapsed = now - created;
    const percentage = Math.min((elapsed / totalTime) * 100, 100);

    // Check if breached
    if (now > due) {
      return { 
        status: 'breached', 
        percentage: 100, 
        color: '#ef4444', 
        label: 'Breached',
        isClosed: false 
      };
    }

    // Check if in warning zone
    const warningThreshold = 80;
    if (percentage >= warningThreshold) {
      return { 
        status: 'warning', 
        percentage, 
        color: '#f59e0b', 
        label: 'At Risk',
        isClosed: false 
      };
    }

    // All good
    return { 
      status: 'ok', 
      percentage, 
      color: '#10b981', 
      label: 'On Track',
        isClosed: false 
    };
  };

  // Format time remaining
  const formatTimeRemaining = (ticket) => {
    if (!ticket.due_date) return 'No SLA set';

    const now = new Date();
    const due = new Date(ticket.due_date);
    const resolved = ticket.resolved_at ? new Date(ticket.resolved_at) : null;
    
    // Check if ticket is closed
    const isClosed = ticket.is_final_status || 
                     ticket.status_code === 'RESOLVED' || 
                     ticket.status_code === 'CLOSED';
    
    if (isClosed) {
      // Show final status for closed tickets
      const resolvedAt = resolved || now;
      const wasMet = resolvedAt <= due;
      
      if (wasMet) {
        const diff = due - resolvedAt;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
          return `Resolved ${days}d ${hours % 24}h before deadline`;
        } else if (hours > 0) {
          return `Resolved ${hours}h before deadline`;
        } else {
          return `Resolved on time`;
        }
      } else {
        const diff = resolvedAt - due;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
          return `Resolved ${days}d ${hours % 24}h after deadline`;
        } else if (hours > 0) {
          return `Resolved ${hours}h after deadline`;
        } else {
          return `Resolved after deadline`;
        }
      }
    }

    // For open tickets, show remaining time
    const diff = due - now;

    if (diff < 0) {
      const hours = Math.abs(Math.floor(diff / (1000 * 60 * 60)));
      const days = Math.floor(hours / 24);
      if (days > 0) {
        return `Overdue by ${days}d ${hours % 24}h`;
      }
      return `Overdue by ${hours}h`;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    if (days > 0) return `${days}d ${hours}h remaining`;
    if (hours > 0) return `${hours}h ${mins}m remaining`;
    return `${mins}m remaining`;
  };

  // Format total SLA time
  const formatTotalSlaTime = (ticket) => {
    if (!ticket.due_date || !ticket.created_at) return 'N/A';

    const created = new Date(ticket.created_at);
    const due = new Date(ticket.due_date);
    const diff = due - created;

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (days > 0) return `${days}d ${hours}h`;
    return `${hours}h`;
  };

  // ============================================
  // END SLA HELPER FUNCTIONS
  // ============================================

  // Get file icon
  const getFileIcon = (fileName) => {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
      return <ImageIcon size={20} />;
    }
    if (['pdf'].includes(ext)) {
      return <FileText size={20} />;
    }
    return <File size={20} />;
  };

  // Format file size
  const formatFileSize = (sizeInKB) => {
    if (sizeInKB < 1024) {
      return `${sizeInKB.toFixed(1)} KB`;
    }
    return `${(sizeInKB / 1024).toFixed(1)} MB`;
  };

  // Download attachment with authentication
  // Developer: Suvadip Panja
  // Date: February 03, 2026
  // Uses axios to fetch file with auth headers, then triggers browser download
  const handleDownloadAttachment = async (attachmentId, fileName) => {
    try {
      console.log('üì• Downloading attachment:', { attachmentId, fileName });

      // Fetch file as blob with authentication
      const response = await api.get(
        `/tickets/${id}/attachments/${attachmentId}/download`,
        {
          responseType: 'blob', // Important: Get response as blob
        }
      );

      console.log('‚úÖ File fetched successfully');

      // Create a temporary URL for the blob
      const url = window.URL.createObjectURL(new Blob([response.data]));
      
      // Create a temporary <a> element to trigger download
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', fileName); // Set the file name
      
      // Append to body, click, and remove
      document.body.appendChild(link);
      link.click();
      
      // Cleanup
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);

      console.log('‚úÖ Download triggered successfully');
    } catch (error) {
      console.error('‚ùå Error downloading attachment:', error);
      alert('Failed to download attachment. Please try again.');
    }
  };

  // Check if user can edit
  const canEdit = () => {
    if (!user || !ticket) return false;
    if (user.permissions?.can_assign_tickets) return true;
    if (ticket.requester_id === user.user_id) return true;
    if (ticket.assigned_to_id === user.user_id) return true;
    return false;
  };

  // Check if user can delete
  const canDelete = () => {
    return user?.permissions?.can_delete_tickets;
  };

  // Check if user can assign
  const canAssign = () => {
    return user?.permissions?.can_assign_tickets;
  };

  // Check if user can close - Only assigned engineer or admin
  // Developer: Suvadip Panja
  // Date: February 04, 2026
  const canClose = () => {
    if (!user || !ticket) return false;
    // Check if ticket is already closed
    if (ticket.status_code === 'CLOSED' || ticket.status_code === 'CANCELLED') return false;
    // Administrator can close any ticket
    if (user.permissions?.can_assign_tickets || user.permissions?.can_manage_system) return true;
    // Assigned engineer can close their tickets
    if (ticket.assigned_to_id === user.user_id) return true;
    return false;
  };

  if (loading) {
    return (
      <div className="ticket-detail-page">
        <div className="loading-container">
          <div className="spinner"></div>
          <p>Loading ticket details...</p>
        </div>
      </div>
    );
  }

  if (error || !ticket) {
    return (
      <div className="ticket-detail-page">
        <div className="error-container">
          <AlertCircle size={64} className="error-icon" />
          <h2>Ticket Not Found</h2>
          <p>{error || 'The ticket you are looking for does not exist or you do not have permission to view it.'}</p>
          <button className="btn-primary" onClick={() => navigate('/tickets')}>
            <ArrowLeft size={18} />
            Back to Tickets
          </button>
        </div>
      </div>
    );
  }

  // Calculate SLA for display
  const slaData = calculateSlaStatus(ticket);

  return (
    <div className="ticket-detail-page">
      {/* Header */}
      <div className="ticket-detail-header">
        <div className="header-left">
          <button className="btn-back" onClick={() => navigate('/tickets')}>
            <ArrowLeft size={20} />
            <span>Back to Tickets</span>
          </button>
          <div className="ticket-number-badge">
            <span className="ticket-hash">#</span>
            <span className="ticket-number">{ticket.ticket_number}</span>
          </div>
          {ticket.is_escalated && (
            <span className="escalated-badge-large">
              <AlertTriangle size={16} />
              <span>Escalated</span>
            </span>
          )}
        </div>
        <div className="header-right">
          <button className="btn-icon-action" onClick={fetchTicketDetails} title="Refresh">
            <RefreshCw size={18} />
          </button>
          {canClose() && (
            <button 
              className="btn-close-ticket" 
              onClick={handleCloseTicket}
              disabled={closeLoading}
              title="Close Ticket"
            >
              {closeLoading ? (
                <RefreshCw size={18} className="spinning" />
              ) : (
                <CheckCircle size={18} />
              )}
              <span>{closeLoading ? 'Closing...' : 'Close'}</span>
            </button>
          )}
          {canEdit() && (
            <button className="btn-secondary" onClick={handleEditTicket}>
              <Edit size={18} />
              <span>Edit</span>
            </button>
          )}
          {canDelete() && (
            <button className="btn-danger" onClick={() => setShowDeleteConfirm(true)}>
              <Trash2 size={18} />
              <span>Delete</span>
            </button>
          )}
        </div>
      </div>

      {/* Main Content */}
      <div className="ticket-detail-content">
        {/* Left Column - Ticket Info */}
        <div className="ticket-info-section">
          {/* Status, Priority, and SLA Badges */}
          <div className="ticket-badges">
            <div className={`status-badge-large ${getStatusColor(ticket.status_code)}`}>
              {getStatusIcon(ticket.status_code)}
              <span>{ticket.status_name}</span>
            </div>
            <div className={`priority-badge-large ${getPriorityColor(ticket.priority_code)}`}>
              {ticket.priority_code === 'CRITICAL' || ticket.priority_code === 'HIGH' ? (
                <AlertTriangle size={18} />
              ) : null}
              <span>{ticket.priority_name}</span>
            </div>
            {/* SLA Badge */}
            <div 
              className={`sla-badge-large sla-${slaData.status}`}
              style={{ borderColor: slaData.color, color: slaData.color }}
            >
              {slaData.status === 'breached' && <XCircle size={18} />}
              {slaData.status === 'met' && <CheckCircle size={18} />}
              {slaData.status === 'warning' && <AlertTriangle size={18} />}
              {slaData.status === 'ok' && <CheckCircle size={18} />}
              {slaData.status === 'none' && <Clock size={18} />}
              <span>{slaData.label}</span>
            </div>
          </div>

          {/* ‚≠ê PHASE 3: CONDITIONAL SLA CARD */}
          {slaData.status !== 'none' && (
            <div className="detail-card sla-card">
              <h2 className="detail-card-title">
                <TrendingUp size={18} />
                SLA Information
              </h2>
              
              {slaData.isClosed ? (
                // CLOSED TICKET: Show final status
                <div className="sla-closed-status">
                  <div 
                    className="sla-final-badge" 
                    style={{ 
                      backgroundColor: slaData.status === 'met' ? '#f0fdf4' : '#fef2f2',
                      borderColor: slaData.color,
                      color: slaData.color
                    }}
                  >
                    {slaData.status === 'met' ? (
                      <CheckCircle size={24} />
                    ) : (
                      <XCircle size={24} />
                    )}
                    <div className="sla-final-content">
                      <span className="sla-final-label">{slaData.label}</span>
                      <span className="sla-final-description">
                        {formatTimeRemaining(ticket)}
                      </span>
                    </div>
                  </div>

                  <div className="sla-details-grid">
                    <div className="sla-detail-item">
                      <label>Total SLA Time</label>
                      <p>{formatTotalSlaTime(ticket)}</p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Started At</label>
                      <p>{formatDate(ticket.created_at)}</p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Due By</label>
                      <p>{formatDate(ticket.due_date)}</p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Resolved At</label>
                      <p className={slaData.status === 'breached' ? 'text-danger' : ''}>
                        {formatDate(ticket.resolved_at || ticket.updated_at)}
                      </p>
                    </div>
                  </div>
                </div>
              ) : (
                // OPEN TICKET: Show progress bar
                <>
                  <div className="sla-progress-section">
                    <div className="sla-progress-header">
                      <span className="sla-progress-label">Time Elapsed</span>
                      <span className="sla-progress-percentage" style={{ color: slaData.color }}>
                        {Math.round(slaData.percentage)}%
                      </span>
                    </div>
                    <div className="sla-progress-bar-large">
                      <div 
                        className="sla-progress-fill-large"
                        style={{ 
                          width: `${Math.min(slaData.percentage, 100)}%`,
                          backgroundColor: slaData.color 
                        }}
                      />
                    </div>
                    <div className="sla-time-remaining-large" style={{ color: slaData.color }}>
                      {formatTimeRemaining(ticket)}
                    </div>
                  </div>

                  <div className="sla-details-grid">
                    <div className="sla-detail-item">
                      <label>Total SLA Time</label>
                      <p>{formatTotalSlaTime(ticket)}</p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Started At</label>
                      <p>{formatDate(ticket.created_at)}</p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Due By</label>
                      <p className={slaData.status === 'breached' ? 'text-danger' : ''}>
                        {formatDate(ticket.due_date)}
                      </p>
                    </div>
                    <div className="sla-detail-item">
                      <label>Time Remaining</label>
                      <p style={{ color: slaData.color, fontWeight: 600 }}>
                        {formatTimeRemaining(ticket)}
                      </p>
                    </div>
                  </div>
                </>
              )}
            </div>
          )}

          {/* Ticket Details Card */}
          <div className="detail-card">
            <h2 className="detail-card-title">Ticket Information</h2>
            
            <div className="detail-item">
              <label>Subject</label>
              <p className="ticket-subject">
                {ticket.subject || ticket.title || 'No Subject'}
              </p>
            </div>

            <div className="detail-item">
              <label>Description</label>
              <p className="ticket-description">
                {ticket.description || 'No description provided'}
              </p>
            </div>

            <div className="detail-grid">
              <div className="detail-item">
                <label>
                  <Tag size={14} />
                  Category
                </label>
                <p>{ticket.category_name || 'N/A'}</p>
              </div>

              <div className="detail-item">
                <label>
                  <User size={14} />
                  Requester
                </label>
                <p>{ticket.requester_name || 'Unknown'}</p>
              </div>

              <div className="detail-item">
                <label>
                  <UserCheck size={14} />
                  Assigned To
                </label>
                <p>{ticket.assigned_to_name || 'Unassigned'}</p>
              </div>

              <div className="detail-item">
                <label>
                  <Calendar size={14} />
                  Created
                </label>
                <p>{formatDate(ticket.created_at)}</p>
              </div>

              {ticket.resolved_at && (
                <div className="detail-item">
                  <label>
                    <CheckCircle size={14} />
                    Resolved At
                  </label>
                  <p>{formatDate(ticket.resolved_at)}</p>
                </div>
              )}

              {ticket.resolution_notes && (
                <div className="detail-item full-width">
                  <label>Resolution Notes</label>
                  <p className="resolution-notes">{ticket.resolution_notes}</p>
                </div>
              )}
            </div>
          </div>

          {/* Assignment Card */}
          {canAssign() && (
            <div className="detail-card">
              <h2 className="detail-card-title">
                <UserCheck size={18} />
                Assign Engineer
              </h2>
              <div className="assign-form">
                <select
                  className="assign-select"
                  value={selectedEngineer}
                  onChange={(e) => setSelectedEngineer(e.target.value)}
                >
                  <option value="">Select Engineer...</option>
                  {engineers.map((engineer) => (
                    <option key={engineer.user_id} value={engineer.user_id}>
                      {engineer.full_name || engineer.username}
                      {engineer.user_id === ticket.assigned_to_id && ' (Current)'}
                    </option>
                  ))}
                </select>
                <button
                  className="btn-assign"
                  onClick={handleAssignEngineer}
                  disabled={assignLoading || !selectedEngineer}
                >
                  <UserCheck size={18} />
                  <span>{assignLoading ? 'Assigning...' : 'Assign'}</span>
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Right Column - Tabs */}
        <div className="ticket-tabs-section">
          {/* Tab Navigation */}
          <div className="tabs-nav">
            <button
              className={`tab-btn ${activeTab === 'comments' ? 'active' : ''}`}
              onClick={() => setActiveTab('comments')}
            >
              <MessageSquare size={18} />
              <span>Comments</span>
              <span className="tab-badge">{comments.length}</span>
            </button>
            <button
              className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
              onClick={() => setActiveTab('activity')}
            >
              <Activity size={18} />
              <span>Activity</span>
              <span className="tab-badge">{activities.length}</span>
            </button>
            <button
              className={`tab-btn ${activeTab === 'attachments' ? 'active' : ''}`}
              onClick={() => setActiveTab('attachments')}
            >
              <Paperclip size={18} />
              <span>Attachments</span>
              <span className="tab-badge">{attachments.length}</span>
            </button>
          </div>

          {/* Tab Content */}
          <div className="tabs-content">
            {/* Comments Tab */}
            {activeTab === 'comments' && (
              <div className="comments-container">
                {/* Add Comment Form */}
                <div className="add-comment-form">
                  <div className="comment-input-wrapper">
                    <textarea
                      value={newComment}
                      onChange={(e) => setNewComment(e.target.value)}
                      placeholder="Write a comment..."
                      className="comment-textarea"
                      rows={4}
                    />
                  </div>
                  <div className="comment-actions">
                    <label className="internal-note-checkbox">
                      <input
                        type="checkbox"
                        checked={isInternalNote}
                        onChange={(e) => setIsInternalNote(e.target.checked)}
                      />
                      {isInternalNote ? <EyeOff size={16} /> : <Eye size={16} />}
                      <span>Internal Note (Staff Only)</span>
                    </label>
                    <button
                      className="btn-primary"
                      onClick={handleAddComment}
                      disabled={commentLoading || !newComment.trim()}
                    >
                      <Send size={16} />
                      <span>{commentLoading ? 'Posting...' : 'Post Comment'}</span>
                    </button>
                  </div>
                </div>

                {/* Comments List */}
                <div className="comments-list">
                  {comments.length === 0 ? (
                    <div className="empty-state-small">
                      <MessageSquare size={48} className="empty-icon" />
                      <p>No comments yet</p>
                      <small>Be the first to comment on this ticket</small>
                    </div>
                  ) : (
                    comments.map((comment) => (
                      <div
                        key={comment.comment_id}
                        className={`comment-item ${comment.is_internal ? 'internal' : ''}`}
                      >
                        <div className="comment-header">
                          <div className="comment-author">
                            <User size={16} />
                            <strong>{comment.commenter_name || 'Unknown'}</strong>
                            {comment.commenter_role && (
                              <span className="comment-role">({comment.commenter_role})</span>
                            )}
                          </div>
                          <div className="comment-meta">
                            {comment.is_internal && (
                              <span className="internal-badge">
                                <EyeOff size={12} />
                                Internal
                              </span>
                            )}
                            <span className="comment-time">{formatDate(comment.commented_at)}</span>
                          </div>
                        </div>
                        <div className="comment-body">
                          {comment.comment_text}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* Activity Tab */}
            {activeTab === 'activity' && (
              <div className="activity-container">
                <div className="activity-list">
                  {activities.length === 0 ? (
                    <div className="empty-state-small">
                      <Activity size={48} className="empty-icon" />
                      <p>No activity yet</p>
                      <small>Activity will appear here as changes are made</small>
                    </div>
                  ) : (
                    activities.map((activity) => (
                      <div key={activity.activity_id} className="activity-item">
                        <div className="activity-icon">
                          <Activity size={16} />
                        </div>
                        <div className="activity-content">
                          <p className="activity-description">{activity.description}</p>
                          <span className="activity-meta">
                            by {activity.performed_by_name || 'System'} ‚Ä¢ {formatDate(activity.performed_at)}
                          </span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* Attachments Tab */}
            {activeTab === 'attachments' && (
              <div className="attachments-container">
                <div className="attachments-list">
                  {attachments.length === 0 ? (
                    <div className="empty-state-small">
                      <Paperclip size={48} className="empty-icon" />
                      <p>No attachments</p>
                      <small>Files attached to this ticket will appear here</small>
                    </div>
                  ) : (
                    attachments.map((attachment) => (
                      <div key={attachment.attachment_id} className="attachment-item">
                        <div className="attachment-icon">
                          {getFileIcon(attachment.file_name)}
                        </div>
                        <div className="attachment-info">
                          <span className="attachment-name">{attachment.file_name}</span>
                          <span className="attachment-meta">
                            {formatFileSize(attachment.file_size_kb)} ‚Ä¢ 
                            {formatDate(attachment.uploaded_at)} ‚Ä¢
                            {attachment.uploaded_by_name || 'Unknown'}
                          </span>
                        </div>
                        <button
                          className="btn-icon-action"
                          onClick={() => handleDownloadAttachment(attachment.attachment_id, attachment.file_name)}
                          title="Download"
                        >
                          <Download size={18} />
                        </button>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="modal-overlay" onClick={() => setShowDeleteConfirm(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this ticket? This action cannot be undone.</p>
            <div className="modal-actions">
              <button 
                className="btn-secondary" 
                onClick={() => setShowDeleteConfirm(false)}
              >
                Cancel
              </button>
              <button 
                className="btn-danger" 
                onClick={() => {
                  handleDeleteTicket();
                  setShowDeleteConfirm(false);
                }}
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TicketDetail;