// ============================================
// TICKET DETAIL PAGE - ENHANCED UI/UX
// Industry-standard design with professional layout
// ============================================
// Developer: Suvadip Panja
// Date: February 03, 2026
// Description: Complete redesign with modern UI patterns
// ============================================

import { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Download,
  Send,
  Paperclip,
  User,
  Clock,
  AlertCircle,
  CheckCircle,
  AlertTriangle,
  Calendar,
  Tag,
  MessageSquare,
  Activity,
  Upload,
  FileText,
  Image as ImageIcon,
  File,
  X,
  Eye,
  EyeOff,
  MoreVertical,
  RefreshCw,
  UserCheck,
  TrendingUp,
  XCircle,
  Mail,
  Phone,
  Building,
  FolderOpen,
  Layers,
  Hash,
  Zap,
  Target,
  Info
} from 'lucide-react';
import api from '../../services/api';
import '../../styles/TicketDetailEnhanced.css';

const TicketDetail = () => {
  const { id } = useParams();
  const { user } = useAuth();
  const navigate = useNavigate();

  // State management
  const [ticket, setTicket] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Comments state
  const [comments, setComments] = useState([]);
  const [newComment, setNewComment] = useState('');
  const [isInternalNote, setIsInternalNote] = useState(false);
  const [commentLoading, setCommentLoading] = useState(false);

  // Activities state
  const [activities, setActivities] = useState([]);

  // Attachments state
  const [attachments, setAttachments] = useState([]);

  // Assignment state
  const [engineers, setEngineers] = useState([]);
  const [selectedEngineer, setSelectedEngineer] = useState('');
  const [assignLoading, setAssignLoading] = useState(false);

  // UI state
  const [activeTab, setActiveTab] = useState('overview');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  // Fetch engineers on mount
  useEffect(() => {
    fetchEngineers();
  }, []);

  // Fetch ticket details on mount
  useEffect(() => {
    if (id) {
      fetchTicketDetails();
    }
  }, [id]);

  // Fetch engineers list
  const fetchEngineers = async () => {
    try {
      const response = await api.get('/system/engineers');
      if (response.data.success) {
        setEngineers(response.data.data);
      }
    } catch (err) {
      console.error('Error fetching engineers:', err);
    }
  };

  // Fetch ticket details
  const fetchTicketDetails = async () => {
    try {
      setLoading(true);
      setError('');

      const response = await api.get(`/tickets/${id}`);

      if (response.data.success) {
        const ticketData = response.data.data;
        setTicket(ticketData);
        setComments(ticketData.comments || []);
        setActivities(ticketData.activities || []);
        setAttachments(ticketData.attachments || []);
        
        // Set currently assigned engineer in dropdown
        if (ticketData.assigned_to_id) {
          setSelectedEngineer(ticketData.assigned_to_id.toString());
        }
      } else {
        setError('Ticket not found');
      }
    } catch (err) {
      console.error('Error fetching ticket:', err);
      setError('Failed to load ticket details');
    } finally {
      setLoading(false);
    }
  };

  // Format date
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('en-IN', {
      timeZone: 'Asia/Kolkata',
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  };

  // Format relative time
  const formatRelativeTime = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return formatDate(dateString);
  };

  // Calculate SLA progress
  const calculateSLAProgress = () => {
    if (!ticket || !ticket.due_date) return null;
    
    const created = new Date(ticket.created_at);
    const due = new Date(ticket.due_date);
    const now = new Date();
    
    const total = due - created;
    const elapsed = now - created;
    const remaining = due - now;
    
    const percentage = Math.min(Math.max((elapsed / total) * 100, 0), 100);
    const hoursRemaining = Math.floor(remaining / (1000 * 60 * 60));
    const minutesRemaining = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    
    return {
      percentage: percentage.toFixed(1),
      isOverdue: remaining < 0,
      hoursRemaining: Math.abs(hoursRemaining),
      minutesRemaining: Math.abs(minutesRemaining),
      status: remaining < 0 ? 'overdue' : remaining < 3600000 ? 'critical' : remaining < 86400000 ? 'warning' : 'on-track'
    };
  };

  // Get priority badge class
  const getPriorityClass = (priorityCode) => {
    const classes = {
      'CRITICAL': 'priority-critical',
      'HIGH': 'priority-high',
      'MEDIUM': 'priority-medium',
      'LOW': 'priority-low'
    };
    return classes[priorityCode] || 'priority-medium';
  };

  // Get status badge class
  const getStatusClass = (statusCode) => {
    const classes = {
      'OPEN': 'status-open',
      'IN_PROGRESS': 'status-in-progress',
      'ON_HOLD': 'status-on-hold',
      'RESOLVED': 'status-resolved',
      'CLOSED': 'status-closed',
      'CANCELLED': 'status-cancelled'
    };
    return classes[statusCode] || 'status-open';
  };

  // Get file icon
  const getFileIcon = (fileName) => {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
      return <ImageIcon size={20} />;
    }
    if (['pdf'].includes(ext)) {
      return <FileText size={20} />;
    }
    return <File size={20} />;
  };

  // Format file size
  const formatFileSize = (sizeInKB) => {
    if (sizeInKB < 1024) {
      return `${sizeInKB} KB`;
    }
    return `${(sizeInKB / 1024).toFixed(1)} MB`;
  };

  // Download attachment with authentication
  const handleDownloadAttachment = async (attachmentId, fileName) => {
    try {
      console.log('ðŸ“¥ Downloading attachment:', { attachmentId, fileName });

      const response = await api.get(
        `/tickets/${id}/attachments/${attachmentId}/download`,
        {
          responseType: 'blob',
        }
      );

      console.log('âœ… File fetched successfully');

      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);

      console.log('âœ… Download triggered successfully');
    } catch (error) {
      console.error('âŒ Error downloading attachment:', error);
      alert('Failed to download attachment. Please try again.');
    }
  };

  // Check if user can edit
  const canEdit = () => {
    if (!user || !ticket) return false;
    if (user.permissions?.can_assign_tickets) return true;
    if (ticket.requester_id === user.user_id) return true;
    if (ticket.assigned_to_id === user.user_id) return true;
    return false;
  };

  // Handle edit
  const handleEdit = () => {
    navigate(`/tickets/${id}/edit`);
  };

  // Handle delete
  const handleDelete = async () => {
    try {
      const response = await api.delete(`/tickets/${id}`);
      if (response.data.success) {
        navigate('/tickets');
      }
    } catch (err) {
      console.error('Error deleting ticket:', err);
      alert('Failed to delete ticket');
    }
  };

  // Handle assign ticket
  const handleAssignTicket = async () => {
    if (!selectedEngineer) {
      alert('Please select an engineer');
      return;
    }

    try {
      setAssignLoading(true);
      const response = await api.patch(`/tickets/${id}/assign`, {
        assigned_to: parseInt(selectedEngineer)
      });

      if (response.data.success) {
        // Refresh ticket details
        fetchTicketDetails();
        alert('Ticket assigned successfully');
      }
    } catch (err) {
      console.error('Error assigning ticket:', err);
      alert('Failed to assign ticket');
    } finally {
      setAssignLoading(false);
    }
  };

  // Handle add comment
  const handleAddComment = async (e) => {
    e.preventDefault();
    
    if (!newComment.trim()) {
      return;
    }

    try {
      setCommentLoading(true);
      const response = await api.post(`/tickets/${id}/comments`, {
        comment_text: newComment,
        is_internal: isInternalNote
      });

      if (response.data.success) {
        setNewComment('');
        setIsInternalNote(false);
        fetchTicketDetails(); // Refresh to get updated comments
      }
    } catch (err) {
      console.error('Error adding comment:', err);
      alert('Failed to add comment');
    } finally {
      setCommentLoading(false);
    }
  };

  // Handle refresh
  const handleRefresh = () => {
    fetchTicketDetails();
  };

  // Loading state
  if (loading) {
    return (
      <div className="ticket-detail-container">
        <div className="loading-state">
          <RefreshCw className="spinner" size={40} />
          <p>Loading ticket details...</p>
        </div>
      </div>
    );
  }

  // Error state
  if (error || !ticket) {
    return (
      <div className="ticket-detail-container">
        <div className="error-state">
          <XCircle size={48} />
          <h2>Error Loading Ticket</h2>
          <p>{error || 'Ticket not found'}</p>
          <button onClick={() => navigate('/tickets')} className="btn-primary">
            <ArrowLeft size={18} />
            Back to Tickets
          </button>
        </div>
      </div>
    );
  }

  const slaProgress = calculateSLAProgress();

  return (
    <div className="ticket-detail-enhanced">
      {/* Header Section */}
      <div className="ticket-header">
        <div className="header-top">
          <button onClick={() => navigate('/tickets')} className="btn-back">
            <ArrowLeft size={20} />
            <span>Back to Tickets</span>
          </button>

          <div className="header-actions">
            <button onClick={handleRefresh} className="btn-icon" title="Refresh">
              <RefreshCw size={20} />
            </button>
            
            {canEdit() && (
              <>
                <button onClick={handleEdit} className="btn-icon" title="Edit">
                  <Edit size={20} />
                </button>
                
                {user.permissions?.can_delete_tickets && (
                  <button 
                    onClick={() => setShowDeleteConfirm(true)} 
                    className="btn-icon btn-danger" 
                    title="Delete"
                  >
                    <Trash2 size={20} />
                  </button>
                )}
              </>
            )}
          </div>
        </div>

        <div className="header-main">
          <div className="ticket-title-section">
            <div className="ticket-number">
              <Hash size={24} />
              <span>{ticket.ticket_number}</span>
            </div>
            <h1 className="ticket-title">{ticket.subject}</h1>
            <div className="ticket-meta">
              <span className="meta-item">
                <Calendar size={16} />
                Created {formatRelativeTime(ticket.created_at)}
              </span>
              <span className="meta-item">
                <User size={16} />
                by {ticket.requester_name}
              </span>
            </div>
          </div>

          <div className="ticket-badges">
            <span className={`badge-status ${getStatusClass(ticket.status_code)}`}>
              {ticket.status_name}
            </span>
            <span className={`badge-priority ${getPriorityClass(ticket.priority_code)}`}>
              {ticket.priority_name}
            </span>
            {ticket.is_escalated && (
              <span className="badge-escalated">
                <AlertTriangle size={16} />
                Escalated
              </span>
            )}
          </div>
        </div>

        {/* SLA Progress Bar */}
        {slaProgress && (
          <div className="sla-progress-container">
            <div className="sla-progress-header">
              <span className="sla-label">
                <Clock size={16} />
                SLA Timeline
              </span>
              <span className={`sla-status sla-${slaProgress.status}`}>
                {slaProgress.isOverdue ? (
                  <>Overdue by {slaProgress.hoursRemaining}h {slaProgress.minutesRemaining}m</>
                ) : (
                  <>{slaProgress.hoursRemaining}h {slaProgress.minutesRemaining}m remaining</>
                )}
              </span>
            </div>
            <div className="sla-progress-bar">
              <div 
                className={`sla-progress-fill sla-${slaProgress.status}`}
                style={{ width: `${slaProgress.percentage}%` }}
              />
            </div>
          </div>
        )}
      </div>

      {/* Main Content */}
      <div className="ticket-content">
        {/* Left Column - Main Info */}
        <div className="content-main">
          {/* Tab Navigation */}
          <div className="tab-nav">
            <button 
              className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
              onClick={() => setActiveTab('overview')}
            >
              <Info size={18} />
              Overview
            </button>
            <button 
              className={`tab-btn ${activeTab === 'comments' ? 'active' : ''}`}
              onClick={() => setActiveTab('comments')}
            >
              <MessageSquare size={18} />
              Comments
              <span className="tab-badge">{comments.length}</span>
            </button>
            <button 
              className={`tab-btn ${activeTab === 'activity' ? 'active' : ''}`}
              onClick={() => setActiveTab('activity')}
            >
              <Activity size={18} />
              Activity
              <span className="tab-badge">{activities.length}</span>
            </button>
            <button 
              className={`tab-btn ${activeTab === 'attachments' ? 'active' : ''}`}
              onClick={() => setActiveTab('attachments')}
            >
              <Paperclip size={18} />
              Attachments
              <span className="tab-badge">{attachments.length}</span>
            </button>
          </div>

          {/* Tab Content */}
          <div className="tab-content">
            {/* Overview Tab */}
            {activeTab === 'overview' && (
              <div className="overview-tab">
                <div className="info-card">
                  <h3 className="card-title">
                    <FileText size={20} />
                    Description
                  </h3>
                  <div className="card-content">
                    <p className="description-text">{ticket.description}</p>
                  </div>
                </div>

                {ticket.resolution_notes && (
                  <div className="info-card">
                    <h3 className="card-title">
                      <CheckCircle size={20} />
                      Resolution
                    </h3>
                    <div className="card-content">
                      <p className="resolution-text">{ticket.resolution_notes}</p>
                      {ticket.resolved_at && (
                        <div className="resolution-meta">
                          <Clock size={16} />
                          Resolved on {formatDate(ticket.resolved_at)}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {attachments.length > 0 && (
                  <div className="info-card">
                    <h3 className="card-title">
                      <Paperclip size={20} />
                      Quick Attachments
                    </h3>
                    <div className="attachments-quick">
                      {attachments.slice(0, 3).map((attachment) => (
                        <div key={attachment.attachment_id} className="attachment-quick-item">
                          <div className="attachment-icon">
                            {getFileIcon(attachment.file_name)}
                          </div>
                          <div className="attachment-info">
                            <span className="attachment-name">{attachment.file_name}</span>
                            <span className="attachment-size">{formatFileSize(attachment.file_size_kb)}</span>
                          </div>
                          <button 
                            onClick={() => handleDownloadAttachment(attachment.attachment_id, attachment.file_name)}
                            className="btn-download-small"
                          >
                            <Download size={16} />
                          </button>
                        </div>
                      ))}
                      {attachments.length > 3 && (
                        <button 
                          onClick={() => setActiveTab('attachments')}
                          className="view-all-link"
                        >
                          View all {attachments.length} attachments â†’
                        </button>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Comments Tab */}
            {activeTab === 'comments' && (
              <div className="comments-tab">
                {/* Add Comment Form */}
                <form onSubmit={handleAddComment} className="comment-form">
                  <div className="form-header">
                    <h3>Add Comment</h3>
                    <label className="internal-note-toggle">
                      <input
                        type="checkbox"
                        checked={isInternalNote}
                        onChange={(e) => setIsInternalNote(e.target.checked)}
                      />
                      <span>Internal Note</span>
                      {isInternalNote && <Eye size={16} />}
                      {!isInternalNote && <EyeOff size={16} />}
                    </label>
                  </div>
                  <textarea
                    value={newComment}
                    onChange={(e) => setNewComment(e.target.value)}
                    placeholder="Type your comment here..."
                    className="comment-textarea"
                    rows="4"
                  />
                  <div className="form-actions">
                    <button 
                      type="submit" 
                      className="btn-primary"
                      disabled={commentLoading || !newComment.trim()}
                    >
                      {commentLoading ? (
                        <RefreshCw className="spinner" size={18} />
                      ) : (
                        <Send size={18} />
                      )}
                      {commentLoading ? 'Posting...' : 'Post Comment'}
                    </button>
                  </div>
                </form>

                {/* Comments List */}
                <div className="comments-list">
                  {comments.length === 0 ? (
                    <div className="empty-state">
                      <MessageSquare size={48} />
                      <p>No comments yet</p>
                      <span>Be the first to comment on this ticket</span>
                    </div>
                  ) : (
                    comments.map((comment) => (
                      <div key={comment.comment_id} className={`comment-item ${comment.is_internal ? 'internal' : ''}`}>
                        <div className="comment-avatar">
                          <User size={24} />
                        </div>
                        <div className="comment-content">
                          <div className="comment-header">
                            <span className="comment-author">{comment.commenter_name}</span>
                            <span className="comment-role">{comment.commenter_role}</span>
                            <span className="comment-time">{formatRelativeTime(comment.commented_at)}</span>
                            {comment.is_internal && (
                              <span className="internal-badge">
                                <Eye size={14} />
                                Internal
                              </span>
                            )}
                          </div>
                          <p className="comment-text">{comment.comment_text}</p>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* Activity Tab */}
            {activeTab === 'activity' && (
              <div className="activity-tab">
                {activities.length === 0 ? (
                  <div className="empty-state">
                    <Activity size={48} />
                    <p>No activity yet</p>
                  </div>
                ) : (
                  <div className="activity-timeline">
                    {activities.map((activity, index) => (
                      <div key={activity.activity_id} className="timeline-item">
                        <div className="timeline-marker"></div>
                        <div className="timeline-content">
                          <div className="activity-header">
                            <span className="activity-type">{activity.activity_type}</span>
                            <span className="activity-time">{formatRelativeTime(activity.performed_at)}</span>
                          </div>
                          <p className="activity-description">{activity.description}</p>
                          {activity.performed_by_name && (
                            <span className="activity-user">
                              by {activity.performed_by_name}
                            </span>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Attachments Tab */}
            {activeTab === 'attachments' && (
              <div className="attachments-tab">
                {attachments.length === 0 ? (
                  <div className="empty-state">
                    <Paperclip size={48} />
                    <p>No attachments</p>
                  </div>
                ) : (
                  <div className="attachments-grid">
                    {attachments.map((attachment) => (
                      <div key={attachment.attachment_id} className="attachment-card">
                        <div className="attachment-preview">
                          {getFileIcon(attachment.file_name)}
                        </div>
                        <div className="attachment-details">
                          <span className="attachment-name" title={attachment.file_name}>
                            {attachment.file_name}
                          </span>
                          <div className="attachment-meta">
                            <span>{formatFileSize(attachment.file_size_kb)}</span>
                            <span>â€¢</span>
                            <span>{formatRelativeTime(attachment.uploaded_at)}</span>
                          </div>
                          <span className="attachment-uploader">
                            by {attachment.uploaded_by_name || 'Unknown'}
                          </span>
                        </div>
                        <button
                          onClick={() => handleDownloadAttachment(attachment.attachment_id, attachment.file_name)}
                          className="btn-download"
                        >
                          <Download size={18} />
                          Download
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Right Column - Sidebar */}
        <div className="content-sidebar">
          {/* Ticket Info Card */}
          <div className="sidebar-card">
            <h3 className="sidebar-title">Ticket Information</h3>
            <div className="info-grid">
              <div className="info-item">
                <span className="info-label">
                  <Tag size={16} />
                  Status
                </span>
                <span className={`info-value badge-status ${getStatusClass(ticket.status_code)}`}>
                  {ticket.status_name}
                </span>
              </div>

              <div className="info-item">
                <span className="info-label">
                  <Zap size={16} />
                  Priority
                </span>
                <span className={`info-value badge-priority ${getPriorityClass(ticket.priority_code)}`}>
                  {ticket.priority_name}
                </span>
              </div>

              <div className="info-item">
                <span className="info-label">
                  <Layers size={16} />
                  Category
                </span>
                <span className="info-value">{ticket.category_name || 'N/A'}</span>
              </div>

              <div className="info-item">
                <span className="info-label">
                  <Building size={16} />
                  Department
                </span>
                <span className="info-value">{ticket.department_name || 'N/A'}</span>
              </div>

              <div className="info-item">
                <span className="info-label">
                  <Calendar size={16} />
                  Created
                </span>
                <span className="info-value">{formatDate(ticket.created_at)}</span>
              </div>

              <div className="info-item">
                <span className="info-label">
                  <Clock size={16} />
                  Due Date
                </span>
                <span className={`info-value ${slaProgress?.isOverdue ? 'text-danger' : ''}`}>
                  {ticket.due_date ? formatDate(ticket.due_date) : 'No SLA'}
                </span>
              </div>

              {ticket.updated_at && (
                <div className="info-item">
                  <span className="info-label">
                    <RefreshCw size={16} />
                    Last Updated
                  </span>
                  <span className="info-value">{formatRelativeTime(ticket.updated_at)}</span>
                </div>
              )}

              {ticket.resolved_at && (
                <div className="info-item">
                  <span className="info-label">
                    <CheckCircle size={16} />
                    Resolved
                  </span>
                  <span className="info-value">{formatDate(ticket.resolved_at)}</span>
                </div>
              )}
            </div>
          </div>

          {/* People Card */}
          <div className="sidebar-card">
            <h3 className="sidebar-title">People</h3>
            <div className="people-list">
              <div className="person-item">
                <div className="person-avatar">
                  <User size={20} />
                </div>
                <div className="person-info">
                  <span className="person-label">Requester</span>
                  <span className="person-name">{ticket.requester_name}</span>
                  {ticket.requester_email && (
                    <span className="person-contact">
                      <Mail size={14} />
                      {ticket.requester_email}
                    </span>
                  )}
                  {ticket.requester_phone && (
                    <span className="person-contact">
                      <Phone size={14} />
                      {ticket.requester_phone}
                    </span>
                  )}
                </div>
              </div>

              {ticket.assigned_to_name && (
                <div className="person-item">
                  <div className="person-avatar assigned">
                    <UserCheck size={20} />
                  </div>
                  <div className="person-info">
                    <span className="person-label">Assigned To</span>
                    <span className="person-name">{ticket.assigned_to_name}</span>
                    {ticket.assigned_to_email && (
                      <span className="person-contact">
                        <Mail size={14} />
                        {ticket.assigned_to_email}
                      </span>
                    )}
                  </div>
                </div>
              )}

              {ticket.escalated_to_name && (
                <div className="person-item">
                  <div className="person-avatar escalated">
                    <AlertTriangle size={20} />
                  </div>
                  <div className="person-info">
                    <span className="person-label">Escalated To</span>
                    <span className="person-name">{ticket.escalated_to_name}</span>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Assignment Card */}
          {user.permissions?.can_assign_tickets && (
            <div className="sidebar-card">
              <h3 className="sidebar-title">Assign Ticket</h3>
              <div className="assignment-form">
                <select
                  value={selectedEngineer}
                  onChange={(e) => setSelectedEngineer(e.target.value)}
                  className="select-engineer"
                >
                  <option value="">Select Engineer</option>
                  {engineers.map((engineer) => (
                    <option key={engineer.user_id} value={engineer.user_id}>
                      {engineer.full_name}
                    </option>
                  ))}
                </select>
                <button
                  onClick={handleAssignTicket}
                  disabled={assignLoading || !selectedEngineer}
                  className="btn-assign"
                >
                  {assignLoading ? (
                    <RefreshCw className="spinner" size={18} />
                  ) : (
                    <UserCheck size={18} />
                  )}
                  {assignLoading ? 'Assigning...' : 'Assign'}
                </button>
              </div>
            </div>
          )}

          {/* Quick Stats Card */}
          <div className="sidebar-card stats-card">
            <h3 className="sidebar-title">Quick Stats</h3>
            <div className="stats-grid">
              <div className="stat-item">
                <MessageSquare size={20} />
                <div className="stat-info">
                  <span className="stat-value">{comments.length}</span>
                  <span className="stat-label">Comments</span>
                </div>
              </div>
              <div className="stat-item">
                <Paperclip size={20} />
                <div className="stat-info">
                  <span className="stat-value">{attachments.length}</span>
                  <span className="stat-label">Attachments</span>
                </div>
              </div>
              <div className="stat-item">
                <Activity size={20} />
                <div className="stat-info">
                  <span className="stat-value">{activities.length}</span>
                  <span className="stat-label">Activities</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="modal-overlay" onClick={() => setShowDeleteConfirm(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <AlertTriangle size={24} />
              <h3>Delete Ticket</h3>
            </div>
            <p>Are you sure you want to delete this ticket? This action cannot be undone.</p>
            <div className="modal-actions">
              <button 
                onClick={() => setShowDeleteConfirm(false)}
                className="btn-secondary"
              >
                Cancel
              </button>
              <button 
                onClick={handleDelete}
                className="btn-danger"
              >
                <Trash2 size={18} />
                Delete Ticket
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TicketDetail;