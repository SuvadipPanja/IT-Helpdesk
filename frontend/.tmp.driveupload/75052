-- ============================================
-- FIX ANNOUNCEMENT SETTINGS - MAKE THEM PUBLIC
-- This script ensures announcement settings are marked as public
-- so they can be loaded on the login page and globally
-- Developer: Suvadip Panja
-- ============================================

USE ITHelpdesk;
GO

-- Step 1: Check current status of announcement settings
SELECT 
    setting_key,
    setting_value,
    setting_category,
    is_public,
    updated_at
FROM system_settings
WHERE setting_key IN ('announcement_enabled', 'system_announcement');
GO

-- Step 2: Update announcement_enabled to be public
UPDATE system_settings
SET 
    is_public = 1,
    updated_at = GETDATE()
WHERE setting_key = 'announcement_enabled';
GO

-- Step 3: Update system_announcement to be public
UPDATE system_settings
SET 
    is_public = 1,
    updated_at = GETDATE()
WHERE setting_key = 'system_announcement';
GO

-- Step 4: Verify the changes
SELECT 
    setting_key,
    setting_value,
    setting_category,
    is_public,
    updated_at
FROM system_settings
WHERE setting_key IN ('announcement_enabled', 'system_announcement');
GO

-- Step 5: Check if settings exist, if not create them
IF NOT EXISTS (SELECT 1 FROM system_settings WHERE setting_key = 'announcement_enabled')
BEGIN
    INSERT INTO system_settings (
        setting_key,
        setting_value,
        setting_category,
        setting_type,
        setting_description,
        is_public,
        created_at,
        updated_at
    )
    VALUES (
        'announcement_enabled',
        'true',
        'general',
        'boolean',
        'Enable or disable system-wide announcement banner',
        1,
        GETDATE(),
        GETDATE()
    );
    PRINT '✅ announcement_enabled setting created';
END
ELSE
BEGIN
    PRINT '✅ announcement_enabled setting already exists';
END
GO

IF NOT EXISTS (SELECT 1 FROM system_settings WHERE setting_key = 'system_announcement')
BEGIN
    INSERT INTO system_settings (
        setting_key,
        setting_value,
        setting_category,
        setting_type,
        setting_description,
        is_public,
        created_at,
        updated_at
    )
    VALUES (
        'system_announcement',
        'Hello User ...',
        'general',
        'string',
        'Message to display in the announcement banner',
        1,
        GETDATE(),
        GETDATE()
    );
    PRINT '✅ system_announcement setting created';
END
ELSE
BEGIN
    PRINT '✅ system_announcement setting already exists';
END
GO

-- Step 6: Final verification - show all public settings
PRINT '=== ALL PUBLIC SETTINGS ===';
SELECT 
    setting_key,
    setting_value,
    setting_category,
    setting_type,
    is_public
FROM system_settings
WHERE is_public = 1
ORDER BY setting_category, setting_key;
GO

PRINT '';
PRINT '✅ Announcement settings are now public!';
PRINT 'Next steps:';
PRINT '1. Restart your backend server (if needed)';
PRINT '2. Clear browser cache (Ctrl+Shift+R)';
PRINT '3. Reload the application';
GO