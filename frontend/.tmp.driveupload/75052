// ============================================
// SYSTEM ANNOUNCEMENT BANNER - COMPLETE VERSION
// Global notification banner with debugging
// Developer: Suvadip Panja
// ============================================

import { useState, useEffect } from 'react';
import { getSetting } from '../../utils/settingsLoader';
import { X, AlertCircle } from 'lucide-react';
import '../../styles/AnnouncementBanner.css';

const AnnouncementBanner = () => {
  const [dismissed, setDismissed] = useState(false);
  const [debugInfo, setDebugInfo] = useState({});

  useEffect(() => {
    // Debug: Check if settings are loaded
    const checkSettings = () => {
      const enabled = getSetting('announcement_enabled', 'false');
      const text = getSetting('system_announcement', '');
      const allSettings = window.APP_SETTINGS;

      const debug = {
        timestamp: new Date().toISOString(),
        settingsLoaded: !!allSettings,
        settingsCount: allSettings ? Object.keys(allSettings).length : 0,
        announcementEnabled: enabled,
        announcementEnabledType: typeof enabled,
        announcementText: text,
        announcementTextLength: text ? text.length : 0,
        allSettingsKeys: allSettings ? Object.keys(allSettings) : []
      };

      setDebugInfo(debug);

      console.log('ðŸ”” === ANNOUNCEMENT BANNER DEBUG ===');
      console.log('ðŸ”” Component Mounted');
      console.log('ðŸ”” Settings Loaded:', debug.settingsLoaded);
      console.log('ðŸ”” Total Settings:', debug.settingsCount);
      console.log('ðŸ”” All Setting Keys:', debug.allSettingsKeys);
      console.log('ðŸ”” announcement_enabled (raw):', enabled);
      console.log('ðŸ”” announcement_enabled (type):', typeof enabled);
      console.log('ðŸ”” system_announcement:', text);
      console.log('ðŸ”” system_announcement (length):', text ? text.length : 0);
      console.log('ðŸ”” window.APP_SETTINGS:', allSettings);
      console.log('ðŸ”” === END DEBUG ===');
    };

    checkSettings();

    // Recheck after 1 second if settings not loaded
    const timer = setTimeout(() => {
      if (!window.APP_SETTINGS || Object.keys(window.APP_SETTINGS).length === 0) {
        console.log('ðŸ”” Retrying settings check...');
        checkSettings();
      }
    }, 1000);

    return () => clearTimeout(timer);
  }, []);

  // Get settings
  const announcementEnabledRaw = getSetting('announcement_enabled', 'false');
  const announcementText = getSetting('system_announcement', '');

  // Parse enabled value - handle multiple formats
  const isEnabled = 
    announcementEnabledRaw === 'true' || 
    announcementEnabledRaw === true || 
    announcementEnabledRaw === 1 ||
    announcementEnabledRaw === '1';

  // Check if should show
  const shouldShow = isEnabled && announcementText && announcementText.trim().length > 0 && !dismissed;

  console.log('ðŸ”” Render Check:', {
    isEnabled,
    hasText: !!announcementText,
    textLength: announcementText ? announcementText.length : 0,
    dismissed,
    shouldShow
  });

  // Don't render if conditions not met
  if (!shouldShow) {
    console.log('ðŸ”” Banner hidden. Reason:', {
      notEnabled: !isEnabled,
      noText: !announcementText || announcementText.trim().length === 0,
      dismissed: dismissed
    });
    return null;
  }

  console.log('âœ… ðŸ”” BANNER VISIBLE! Rendering announcement...');

  return (
    <div className="announcement-banner">
      <div className="announcement-content">
        <AlertCircle size={18} className="announcement-icon" />
        <p className="announcement-text">{announcementText}</p>
      </div>
      <button 
        className="announcement-close"
        onClick={() => {
          console.log('ðŸ”” Announcement dismissed by user');
          setDismissed(true);
        }}
        aria-label="Dismiss announcement"
      >
        <X size={18} />
      </button>
    </div>
  );
};

export default AnnouncementBanner;