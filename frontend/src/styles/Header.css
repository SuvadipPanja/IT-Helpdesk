// ============================================
// HEADER COMPONENT WITH ANNOUNCEMENT TICKER
// Top navigation bar with scrolling announcement
// UPDATED: Added announcement ticker in header center
// ============================================

import { useState, useRef, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { useNotification } from '../../context/notifications/NotificationContext';
import { getSetting } from '../../utils/settingsLoader';
import '../../styles/Header.css';
import '../../styles/AnnouncementTicker.css'; // Import ticker styles
import {
  Menu,
  Bell,
  User,
  Settings,
  LogOut,
  ChevronDown,
  HelpCircle,
  Shield,
  Trash2,
  Eye,
  CheckCheck,
  AlertCircle,
  X,
  Info,
  CheckCircle,
  AlertTriangle,
} from 'lucide-react';

// ============================================
// HEADER COMPONENT
// ============================================
const Header = ({ toggleSidebar }) => {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  
  // ============================================
  // ANNOUNCEMENT STATE
  // ============================================
  const [announcementDismissed, setAnnouncementDismissed] = useState(false);
  
  // Get announcement settings
  const announcementEnabled = getSetting('announcement_enabled', 'false') === 'true';
  const announcementText = getSetting('system_announcement', '');
  
  // Determine announcement type/variant (you can make this dynamic in settings)
  const announcementType = 'info'; // Options: 'info', 'success', 'warning', 'error'
  
  // Debug: Log user info when component mounts
  useEffect(() => {
    console.log('ðŸ” Header - Current user:', user);
    console.log('ðŸ” Header - User role:', user?.role_code);
    console.log('ðŸ” Header - User role name:', user?.role_name);
  }, [user]);
  
  // ============================================
  // NOTIFICATION CONTEXT
  // Access real notification data and functions
  // ============================================
  const {
    notifications,
    unreadCount,
    fetchNotifications,
    markAsRead,
    markAllAsRead,
    deleteNotification,
  } = useNotification();

  // ============================================
  // LOCAL STATE
  // ============================================
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [loadingNotifications, setLoadingNotifications] = useState(false);
  const userMenuRef = useRef(null);
  const notificationsRef = useRef(null);

  // ============================================
  // CLOSE DROPDOWNS WHEN CLICKING OUTSIDE
  // ============================================
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (userMenuRef.current && !userMenuRef.current.contains(event.target)) {
        setShowUserMenu(false);
      }
      if (notificationsRef.current && !notificationsRef.current.contains(event.target)) {
        setShowNotifications(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // ============================================
  // LOGOUT HANDLER
  // ============================================
  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  // ============================================
  // TOGGLE USER MENU
  // ============================================
  const toggleUserMenu = () => {
    setShowUserMenu(!showUserMenu);
    setShowNotifications(false);
  };

  // ============================================
  // TOGGLE NOTIFICATIONS DROPDOWN
  // Fetches notifications when opened
  // ============================================
  const toggleNotifications = async () => {
    const newState = !showNotifications;
    setShowNotifications(newState);
    setShowUserMenu(false);

    // ALWAYS fetch fresh notifications when opening dropdown
    if (newState) {
      setLoadingNotifications(true);
      try {
        await fetchNotifications(1, 20); // Get first 20 notifications
        console.log('âœ… Notifications fetched successfully');
      } catch (error) {
        console.error('âŒ Error fetching notifications:', error);
      } finally {
        setLoadingNotifications(false);
      }
    }
  };

  // ============================================
  // HANDLE NOTIFICATION CLICK
  // Mark as read and navigate to related ticket
  // ============================================
  const handleNotificationClick = async (notification) => {
    try {
      // Mark as read
      if (!notification.is_read) {
        await markAsRead(notification.notification_id);
      }

      // Navigate to ticket if available
      if (notification.ticket_id) {
        navigate(`/tickets/${notification.ticket_id}`);
      }

      // Close dropdown
      setShowNotifications(false);
    } catch (error) {
      console.error('Error handling notification click:', error);
    }
  };

  // ============================================
  // MARK ALL NOTIFICATIONS AS READ
  // ============================================
  const handleMarkAllAsRead = async () => {
    try {
      await markAllAsRead();
      console.log('âœ… All notifications marked as read');
    } catch (error) {
      console.error('Error marking all as read:', error);
    }
  };

  // ============================================
  // DELETE NOTIFICATION
  // ============================================
  const handleDeleteNotification = async (notificationId, event) => {
    event.stopPropagation();
    try {
      await deleteNotification(notificationId);
      console.log('âœ… Notification deleted');
    } catch (error) {
      console.error('Error deleting notification:', error);
    }
  };

  // ============================================
  // GET NOTIFICATION ICON
  // ============================================
  const getNotificationIcon = (type) => {
    switch (type) {
      case 'TICKET_CREATED':
      case 'TICKET_ASSIGNED':
        return 'ðŸŽ«';
      case 'TICKET_UPDATED':
      case 'TICKET_STATUS_CHANGED':
        return 'ðŸ”„';
      case 'TICKET_COMMENT':
        return 'ðŸ’¬';
      case 'TICKET_RESOLVED':
      case 'TICKET_CLOSED':
        return 'âœ…';
      case 'TICKET_ESCALATED':
        return 'âš ï¸';
      case 'USER_MENTION':
        return 'ðŸ‘¤';
      case 'SYSTEM':
        return 'âš™ï¸';
      case 'LOGIN':
        return 'ðŸ”';
      case 'PASSWORD_CHANGED':
        return 'ðŸ”‘';
      default:
        return 'ðŸ“¢';
    }
  };

  // ============================================
  // GET ANNOUNCEMENT ICON BY TYPE
  // ============================================
  const getAnnouncementIcon = () => {
    switch (announcementType) {
      case 'success':
        return <CheckCircle size={16} className="announcement-ticker-icon" />;
      case 'warning':
        return <AlertTriangle size={16} className="announcement-ticker-icon" />;
      case 'error':
        return <AlertCircle size={16} className="announcement-ticker-icon" />;
      default:
        return <Info size={16} className="announcement-ticker-icon" />;
    }
  };

  // ============================================
  // RENDER COMPONENT
  // ============================================
  return (
    <header className="header">
      {/* Left Section - Hamburger Menu */}
      <div className="header-left">
        <button 
          className="btn-icon-header hamburger-btn"
          onClick={toggleSidebar}
          aria-label="Toggle Sidebar"
        >
          <Menu size={20} />
        </button>
      </div>
	  
      {/* ============================================
          CENTER SECTION - ANNOUNCEMENT TICKER
          Scrolls from right to left smoothly
          ============================================ */}
      <div className="header-center">
        {announcementEnabled && announcementText.trim() && !announcementDismissed && (
          <div className={`announcement-ticker-container ticker-${announcementType}`}>
            {/* Scrolling Wrapper - Duplicates content for seamless loop */}
            <div className="announcement-ticker-wrapper">
              {/* First Instance */}
              <div className="announcement-ticker-content">
                {getAnnouncementIcon()}
                <span className="announcement-badge">NEW</span>
                <span className="announcement-ticker-text">{announcementText}</span>
                <span className="announcement-separator"></span>
              </div>
              
              {/* Second Instance - Creates seamless loop */}
              <div className="announcement-ticker-content">
                {getAnnouncementIcon()}
                <span className="announcement-badge">NEW</span>
                <span className="announcement-ticker-text">{announcementText}</span>
                <span className="announcement-separator"></span>
              </div>
            </div>
            
            {/* Close Button */}
            <button 
              className="announcement-ticker-close"
              onClick={() => setAnnouncementDismissed(true)}
              aria-label="Dismiss announcement"
            >
              <X size={14} />
            </button>
          </div>
        )}
      </div>
	  
      {/* Right Section - Notifications & User Menu */}
      <div className="header-right">
        
        {/* ============================================
            NOTIFICATIONS DROPDOWN
            Connected to real API via NotificationContext
            ============================================ */}
        <div className="header-dropdown" ref={notificationsRef}>
          <button 
            className="btn-icon-header"
            onClick={toggleNotifications}
            aria-label="Notifications"
          >
            <Bell size={20} />
            {unreadCount > 0 && (
              <span className="notification-badge">{unreadCount}</span>
            )}
          </button>

          {showNotifications && (
            <div className="dropdown-menu notifications-menu">
              {/* Dropdown Header */}
              <div className="dropdown-header">
                <h3>Notifications</h3>
                {notifications.length > 0 && unreadCount > 0 && (
                  <button 
                    className="btn-text-small"
                    onClick={handleMarkAllAsRead}
                    title="Mark all as read"
                  >
                    <CheckCheck size={14} />
                    Mark all read
                  </button>
                )}
              </div>

              {/* Dropdown Body */}
              <div className="dropdown-body">
                {loadingNotifications ? (
                  // Loading State
                  <div className="empty-notifications">
                    <Bell size={32} className="empty-icon" />
                    <p>Loading notifications...</p>
                  </div>
                ) : notifications.length === 0 ? (
                  // Empty State
                  <div className="empty-notifications">
                    <Bell size={32} className="empty-icon" />
                    <p>No notifications</p>
                    <small>You're all caught up!</small>
                  </div>
                ) : (
                  // Notifications List
                  notifications.map((notification) => (
                    <div 
                      key={notification.notification_id} 
                      className={`notification-item ${!notification.is_read ? 'unread' : ''}`}
                      onClick={() => handleNotificationClick(notification)}
                    >
                      <div className="notification-icon">
                        {getNotificationIcon(notification.type)}
                      </div>
                      <div className="notification-content">
                        <p className="notification-message">{notification.message}</p>
                        <span className="notification-time">{notification.created_at}</span>
                      </div>
                      <button 
                        className="notification-delete"
                        onClick={(e) => handleDeleteNotification(notification.notification_id, e)}
                        title="Delete notification"
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  ))
                )}
              </div>

              {/* View All Link */}
              {notifications.length > 0 && (
                <div className="dropdown-footer">
                  <button 
                    className="btn-text-small"
                    onClick={() => {
                      navigate('/notifications');
                      setShowNotifications(false);
                    }}
                  >
                    <Eye size={14} />
                    View All Notifications
                  </button>
                </div>
              )}
            </div>
          )}
        </div>

        {/* ============================================
            USER MENU DROPDOWN
            Profile, Settings, Help, Logout
            ============================================ */}
        <div className="header-dropdown" ref={userMenuRef}>
          <button 
            className="user-menu-trigger"
            onClick={toggleUserMenu}
            aria-label="User Menu"
          >
            <div className="user-avatar-header">
              {user?.first_name?.charAt(0) || user?.username?.charAt(0) || 'U'}
            </div>
            <div className="user-info-header">
              <span className="user-name">{user?.first_name && user?.last_name ? `${user.first_name} ${user.last_name}` : user?.username}</span>
              <span className="user-role">{user?.role_name}</span>
            </div>
            <ChevronDown size={16} className={`chevron-icon ${showUserMenu ? 'rotated' : ''}`} />
          </button>

          {showUserMenu && (
            <div className="dropdown-menu user-dropdown-menu">
              {/* User Info Header */}
              <div className="dropdown-header-user">
                <div className="user-avatar-large">
                  {user?.first_name?.charAt(0) || user?.username?.charAt(0) || 'U'}
                </div>
                <div className="user-info-dropdown">
                  <h4>{user?.first_name && user?.last_name ? `${user.first_name} ${user.last_name}` : user?.username}</h4>
                  <p>{user?.email}</p>
                  <span className={`role-badge-small role-${user?.role_code?.toLowerCase()}`}>
                    {user?.role_name}
                  </span>
                </div>
              </div>

              {/* Menu Items */}
              <div className="dropdown-body-menu">
                <button 
                  className="dropdown-item"
                  onClick={() => {
                    navigate('/profile');
                    setShowUserMenu(false);
                  }}
                >
                  <User size={18} />
                  <span>My Profile</span>
                </button>

                <button 
                  className="dropdown-item"
                  onClick={() => {
                    navigate('/settings');
                    setShowUserMenu(false);
                  }}
                >
                  <Settings size={18} />
                  <span>Settings</span>
                </button>

                <button 
                  className="dropdown-item"
                  onClick={() => {
                    navigate('/help');
                    setShowUserMenu(false);
                  }}
                >
                  <HelpCircle size={18} />
                  <span>Help Center</span>
                </button>

                {user?.role_code === 'Administrator' && (
                  <button 
                    className="dropdown-item"
                    onClick={() => {
                      navigate('/roles');
                      setShowUserMenu(false);
                    }}
                  >
                    <Shield size={18} />
                    <span>Role Management</span>
                  </button>
                )}

                <div className="dropdown-divider"></div>

                <button 
                  className="dropdown-item logout-item"
                  onClick={handleLogout}
                >
                  <LogOut size={18} />
                  <span>Logout</span>
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </header>
  );
};

// ============================================
// EXPORT COMPONENT
// ============================================
export default Header;